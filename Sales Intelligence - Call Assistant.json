{
  "name": "Sales Intelligence - Call Assistant",
  "nodes": [
    {
      "parameters": {
        "path": "get-tips/overlay",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, OPTIONS"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        624,
        672
      ],
      "id": "9fce160a-917e-4a59-b6c5-29f2169b79dd",
      "name": "Webhook GET Endpoint für Overlay",
      "webhookId": "3e006b67-7114-4024-9ab5-269776493935"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "ViMShJYvyT8q2ZCA",
          "mode": "list",
          "cachedResultName": "transcripts_log",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/ViMShJYvyT8q2ZCA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "session_id": "={{ $('Webhook1').item.json.body.session_id }}",
            "source": "={{ Array.isArray($node[\"Webhook1\"].json.body.speaker) \n   ? $node[\"Webhook1\"].json.body.speaker[0] \n   : $node[\"Webhook1\"].json.body.speaker }}",
            "ts": "={{ $now.toMillis() }}",
            "text": "={{ $json.text }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "text",
              "displayName": "text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "optimizeBulk": false
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1728,
        112
      ],
      "id": "26cab1b4-1c53-466d-9e47-3004e911f6dc",
      "name": "Insert row"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "USckcZCOM7Vn9SWp",
          "mode": "list",
          "cachedResultName": "workflow_state",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/USckcZCOM7Vn9SWp"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "state_key": "current_call",
            "active_session_id": "={{ $json.session_id }}",
            "last_processed_ts": "={{ $now.toMillis() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "state_key",
              "displayName": "state_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "active_session_id",
              "displayName": "active_session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "last_processed_ts",
              "displayName": "last_processed_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2064,
        112
      ],
      "id": "f24bc32c-5c44-4629-a05d-e844000eacfe",
      "name": "Upsert row(s)"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ViMShJYvyT8q2ZCA",
          "mode": "list",
          "cachedResultName": "transcripts_log",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/ViMShJYvyT8q2ZCA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "keyValue": "={{ $json.session_id }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1424,
        880
      ],
      "id": "bfbfa2ed-f4e4-4ff2-b467-9739d73c636e",
      "name": "Get Transcripts",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "5cd5e799-69ed-440b-a130-2bbc8d50ed62",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "get_active_session",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c2a45b80-e5b6-4f0c-a4f3-69271e56120d",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "get_active_session",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": 0
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1056,
        672
      ],
      "id": "99651366-5570-4c80-a032-888ad9a5d4eb",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "USckcZCOM7Vn9SWp",
          "mode": "list",
          "cachedResultName": "workflow_state",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/USckcZCOM7Vn9SWp"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1728,
        656
      ],
      "id": "480cd94a-0be5-4670-9f9e-2267b3d9ef48",
      "name": "Get row(s)",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// KI-BREMSE v2.3 – Context Packager Output + Burst Pacing + Ref Query\n// IMPROVED: Intelligent 66-Branch Detection with Fallback\n// Input erwartet:\n//  - live_context.you / live_context.them\n//  - live_context.talk_ratio_pct_you / talk_ratio_pct_them\n//  - live_context.duration_sec\n//  - memory_context.customer / topics\n// =====================================================\n\nconst staticData = $getWorkflowStaticData(\"global\");\n\n// -----------------------------\n// CONFIG\n// -----------------------------\nconst MIN_WPM_WINDOW_SEC = 15;\nconst STABLE_MAX_SEC = 60;\nconst BURST_MIN_SEC = 10;\nconst BURST_MAX_SEC = 25;\n\nconst DOMINANCE_WINDOW_N = 8;\nconst DOM_YOU = 60;\nconst DOM_THEM = 40;\n\nconst PACE_FAST_WPM = 170;\nconst PACE_SLOW_WPM = 70;\n\n// -----------------------------\n// INPUT\n// -----------------------------\nconst live = $json.live_context || {};\nconst mem = $json.memory_context || {};\n\nfunction firstNonEmpty(...vals) {\n  for (const v of vals) {\n    if (v !== null && v !== undefined) {\n      const s = String(v).trim();\n      if (s) return s;\n    }\n  }\n  return \"\";\n}\n\nfunction safeNode(pathFn) {\n  try { return pathFn(); } catch (_) { return null; }\n}\n\nconst session_id = firstNonEmpty(\n  $json.session_id,\n  live.session_id,\n  mem.session_id\n) || null;\n\nconst lead_id = firstNonEmpty(\n  $json.lead_id,\n  live.lead_id,\n  mem.lead_id,\n  safeNode(() => $('Webhook1').first().json.body.ID),\n  safeNode(() => $('Get row(s)').first().json.lead_id),\n  safeNode(() => $('Get row(s)').first().json.id)\n) || 'unknown_lead';\n\nconst liveYouText = String(live.you || \"\").trim();\nconst liveThemText = String(live.them || \"\").trim();\n\nconst talk_you_raw = live.talk_ratio_pct_you;\nconst talk_them_raw = live.talk_ratio_pct_them;\n\nconst memory_topics = Array.isArray(mem.topics) ? mem.topics : [];\nconst memory_context_text = String(mem.customer || \"\").trim();\n\n// duration clamp\nlet duration_sec = Number(live.duration_sec ?? 0);\nif (!Number.isFinite(duration_sec) || duration_sec <= 0) duration_sec = 60;\nduration_sec = Math.max(5, Math.min(120, duration_sec));\n\n// stable/burst windows\nconst stableDurationSec = Math.min(STABLE_MAX_SEC, Math.max(MIN_WPM_WINDOW_SEC, duration_sec));\nconst burstDurationSec = Math.min(BURST_MAX_SEC, Math.max(BURST_MIN_SEC, duration_sec));\n// -----------------------------\n// HELPERS\n// -----------------------------\nfunction countWords(text) {\n  if (!text) return 0;\n  return text.trim().split(/\\s+/).filter(Boolean).length;\n}\n\nfunction pacingStatusFromWpm(wpm) {\n  if (!wpm || wpm <= 0) return \"n/a\";\n  if (wpm > PACE_FAST_WPM) return \"too_fast\";\n  if (wpm < PACE_SLOW_WPM) return \"too_slow\";\n  return \"ok\";\n}\n\nfunction clip(s, n) {\n  s = String(s || \"\").replace(/\\s+/g, \" \").trim();\n  if (!s) return \"\";\n  return s.length > n ? s.slice(0, n) : s;\n}\n\n// -----------------------------\n// WORDS\n// -----------------------------\nconst words_you = countWords(liveYouText);\nconst words_them = countWords(liveThemText);\n\n// -----------------------------\n// WPM (Stable + Burst)\n// -----------------------------\nconst wpm_you = Math.round((words_you / stableDurationSec) * 60);\nconst wpm_them = Math.round((words_them / stableDurationSec) * 60);\n\nconst wpm_burst_you = Math.round((words_you / burstDurationSec) * 60);\nconst wpm_burst_them = Math.round((words_them / burstDurationSec) * 60);\n\nconst pacing_you = pacingStatusFromWpm(wpm_burst_you);\nconst pacing_them = pacingStatusFromWpm(wpm_burst_them);\n\n// -----------------------------\n// TALK RATIO (prefer live metrics)\n// -----------------------------\nlet talk_ratio_pct_you = (typeof talk_you_raw === \"number\") ? talk_you_raw : null;\nlet talk_ratio_pct_them = (typeof talk_them_raw === \"number\") ? talk_them_raw : null;\n\nif (talk_ratio_pct_you === null || talk_ratio_pct_them === null) {\n  const total = words_you + words_them;\n  talk_ratio_pct_you = total > 0 ? Math.round((words_you / total) * 100) : 0;\n  talk_ratio_pct_them = total > 0 ? 100 - talk_ratio_pct_you : 0;\n}\n\ntalk_ratio_pct_you = Math.max(0, Math.min(100, talk_ratio_pct_you));\ntalk_ratio_pct_them = Math.max(0, Math.min(100, talk_ratio_pct_them));\n\n// -----------------------------\n// DOMINANCE (rolling avg)\n// -----------------------------\nif (!Array.isArray(staticData.talk_ratio_memory)) staticData.talk_ratio_memory = [];\nstaticData.talk_ratio_memory.push(talk_ratio_pct_you);\nstaticData.talk_ratio_memory = staticData.talk_ratio_memory.slice(-DOMINANCE_WINDOW_N);\n\nconst avg_you = Math.round(\n  staticData.talk_ratio_memory.reduce((a,b) => a + b, 0) / staticData.talk_ratio_memory.length\n);\n\nlet dominates = \"balanced\";\nif (avg_you > DOM_YOU) dominates = \"you\";\nelse if (avg_you < DOM_THEM) dominates = \"them\";\n\n// -----------------------------\n// WARNINGS\n// -----------------------------\nconst burst_warning = (wpm_burst_you > PACE_FAST_WPM);\nconst pacing_warning = (pacing_you === \"too_fast\") || burst_warning;\nconst talk_ratio_warning = (dominates === \"you\") || (talk_ratio_pct_you > 55);\n\n// -----------------------------\n// CONTEXT for AI\n// -----------------------------\nconst live_context_text = `THEM: ${liveThemText}\\nYOU: ${liveYouText}`.trim();\n\n// =====================================================\n// BRANCHENFILTER v2.0 – Alle 66 Branchen mit Keywords\n// =====================================================\n\n// Komplette Liste aller 66 Branchen mit UMFASSENDEN Keywords (15-25 pro Branche)\nconst BRANCHE_KEYWORDS = {\n  // =====================================================\n  // KUNST & KULTUR\n  // =====================================================\n  \"Kunst\": [\n    \"kunst\", \"künstler\", \"galerie\", \"gemälde\", \"skulptur\", \"kunstwerk\", \"atelier\", \"malerei\", \"bildhauer\", \"kunsthandwerk\",\n    \"ausstellung\", \"vernissage\", \"kunstausstellung\", \"moderne kunst\", \"zeitgenössische kunst\", \"ölgemälde\", \"aquarell\",\n    \"installation\", \"kunstgalerie\", \"kunstsammlung\", \"kunstobjekt\", \"kunstszene\", \"kunstmarkt\", \"artsy\", \"art\",\n    \"kreativität\", \"expressionismus\", \"abstrakt\", \"realismus\", \"portrait\", \"landschaftsmalerei\", \"grafik\", \"druckgrafik\",\n    \"lithografie\", \"radierung\", \"kunstprojekt\", \"kunstförderung\", \"kulturförderung\", \"kunstverein\", \"atelierbesuch\"\n  ],\n  \"Kino\": [\n    \"kino\", \"film\", \"movie\", \"leinwand\", \"popcorn\", \"blockbuster\", \"premiere\", \"kinosaal\", \"filmvorführung\",\n    \"kinofilm\", \"filmabend\", \"kinokarte\", \"kinoticket\", \"multiplex\", \"arthouse\", \"programmkino\", \"filmtheater\",\n    \"3d kino\", \"imax\", \"dolby\", \"surround\", \"filmstart\", \"kinobesuch\", \"sneak preview\", \"filmpalast\",\n    \"kinoprogramm\", \"spielfilm\", \"dokumentarfilm\", \"kurzfilm\", \"trailer\", \"vorschau\", \"kinosessel\", \"filmrolle\",\n    \"kinogutschein\", \"kinoabend\", \"open air kino\", \"sommerkino\", \"autokino\", \"filmfestival\"\n  ],\n  \"Museen\": [\n    \"museum\", \"ausstellung\", \"sammlung\", \"artefakt\", \"kurator\", \"museumspädagogik\", \"dauerausstellung\",\n    \"sonderausstellung\", \"wechselausstellung\", \"exponat\", \"kunstmuseum\", \"naturkundemuseum\", \"historisches museum\",\n    \"technikmuseum\", \"völkerkundemuseum\", \"stadtmuseum\", \"heimatmuseum\", \"freilichtmuseum\", \"museumsführung\",\n    \"audioguide\", \"museumshop\", \"museumsbesuch\", \"kulturgeschichte\", \"archäologie\", \"antiquitäten\", \"reliquie\",\n    \"museumsinsel\", \"kulturerbe\", \"weltkulturerbe\", \"restaurierung\", \"konservierung\", \"depotführung\", \"schausammlung\"\n  ],\n  \"Theater\": [\n    \"theater\", \"bühne\", \"schauspiel\", \"aufführung\", \"premiere\", \"ensemble\", \"theaterstück\", \"regie\", \"dramaturgie\",\n    \"theatervorstellung\", \"schauspielhaus\", \"staatstheater\", \"stadttheater\", \"komödie\", \"tragödie\", \"drama\",\n    \"musical\", \"oper\", \"operette\", \"ballett\", \"theaterkarte\", \"parkett\", \"rang\", \"loge\", \"vorhang\",\n    \"applaus\", \"zugabe\", \"pause\", \"garderobe\", \"bühnenbild\", \"kostüm\", \"maske\", \"souffleur\", \"intendant\",\n    \"spielzeit\", \"repertoire\", \"uraufführung\", \"gastspiel\", \"tournee\", \"theaterabonnement\", \"kulturticket\"\n  ],\n  \"Konzerte\": [\n    \"konzert\", \"live musik\", \"festival\", \"orchester\", \"band\", \"auftritt\", \"bühne\", \"open air\", \"musikveranstaltung\",\n    \"konzerthalle\", \"philharmonie\", \"arena\", \"stadion\", \"club konzert\", \"akustik\", \"soundcheck\", \"setlist\",\n    \"encore\", \"zugabe\", \"moshpit\", \"standing\", \"sitzplatz\", \"konzertticket\", \"vorverkauf\", \"abendkasse\",\n    \"headliner\", \"support act\", \"vorband\", \"tour\", \"tournee\", \"album release\", \"unplugged\", \"acoustic\",\n    \"sinfoniekonzert\", \"kammerkonzert\", \"jazzkonzert\", \"rockkonzert\", \"popkonzert\", \"klassik\", \"weltmusik\"\n  ],\n  \"Shows / Austellungen\": [\n    \"show\", \"vorstellung\", \"performance\", \"darbietung\", \"entertainment\", \"spektakel\", \"bühnenprogramm\",\n    \"varieté\", \"kabarett\", \"comedy\", \"magic show\", \"zauberer\", \"akrobatik\", \"artistik\", \"zirkus\",\n    \"revue\", \"dinner show\", \"talentshow\", \"gameshow\", \"live show\", \"talkshow\", \"late night\",\n    \"unterhaltung\", \"showact\", \"moderation\", \"entertainer\", \"publikum\", \"interaktiv\", \"lichtshow\", \"lasershow\",\n    \"feuerwerk\", \"pyrotechnik\", \"special effects\", \"stunts\", \"illusionist\", \"bauchredner\"\n  ],\n\n  // =====================================================\n  // GASTRONOMIE (nur bei klaren Hinweisen!)\n  // =====================================================\n  \"Fine Dining\": [\n    \"fine dining\", \"gourmet\", \"sterne restaurant\", \"michelin\", \"haute cuisine\", \"degustationsmenü\", \"sommelier\", \"edel restaurant\",\n    \"sterneküche\", \"spitzenküche\", \"gehobene küche\", \"kulinarisch\", \"gänge menü\", \"amuse bouche\", \"tasting menu\",\n    \"weinbegleitung\", \"weinkarte\", \"champagner\", \"trueffel\", \"kaviar\", \"hummer\", \"gourmetküche\", \"feinschmecker\",\n    \"luxus restaurant\", \"premium dining\", \"exklusiv essen\", \"nobel restaurant\", \"chef table\", \"küchenchef\",\n    \"sternekoch\", \"bocuse\", \"guide michelin\", \"gault millau\", \"kulinarische reise\", \"geschmackserlebnis\"\n  ],\n  \"Casual Dining\": [\n    \"restaurant\", \"essen gehen\", \"speisekarte\", \"menü\", \"kellner\", \"reservierung\", \"abendessen\", \"mittagessen\", \"tisch reservieren\",\n    \"lokal\", \"gaststätte\", \"gasthaus\", \"gasthof\", \"wirtshaus\", \"trattoria\", \"bistro\", \"brasserie\", \"taverne\",\n    \"ristorante\", \"cucina\", \"küche\", \"koch\", \"bedienung\", \"service\", \"rechnung\", \"trinkgeld\", \"tagesmenü\",\n    \"mittagstisch\", \"businesslunch\", \"familienrestaurant\", \"brunch\", \"frühstück\", \"vorspeise\", \"hauptgang\", \"dessert\",\n    \"nachtisch\", \"beilage\", \"getränkekarte\", \"hausmannskost\", \"regionale küche\", \"internationale küche\", \"buffet\"\n  ],\n  \"Fast Food\": [\n    \"fast food\", \"burger\", \"pizza\", \"hotdog\", \"pommes\", \"schnellimbiss\", \"drive through\", \"takeaway\", \"döner\", \"kebab\",\n    \"imbiss\", \"snack\", \"quick service\", \"systemgastronomie\", \"mcdonalds\", \"burger king\", \"subway\", \"kfc\",\n    \"five guys\", \"shake shack\", \"currywurst\", \"bratwurst\", \"falafel\", \"wrap\", \"burrito\", \"taco\",\n    \"nuggets\", \"chicken wings\", \"onion rings\", \"milchshake\", \"softdrink\", \"cola\", \"combo menü\", \"happy meal\",\n    \"to go\", \"mitnehmen\", \"selbstbedienung\", \"food court\", \"schnellrestaurant\", \"fritteuse\", \"grill\"\n  ],\n  \"Cafés\": [\n    \"café\", \"kaffee\", \"cappuccino\", \"espresso\", \"latte\", \"matcha\", \"kuchen\", \"konditorei\", \"kaffeebar\", \"barista\",\n    \"coffee shop\", \"kaffeehaus\", \"kaffeespezialitäten\", \"filterkaffee\", \"cold brew\", \"flat white\", \"americano\",\n    \"macchiato\", \"mokka\", \"croissant\", \"gebäck\", \"torte\", \"patisserie\", \"backstube\", \"bäckerei\",\n    \"frühstückscafé\", \"brunch café\", \"kaffee und kuchen\", \"nachmittagskaffee\", \"kaffeepause\", \"kaffeeklatsch\",\n    \"heißgetränk\", \"tee\", \"chai latte\", \"heiße schokolade\", \"kakao\", \"smoothie\", \"säfte\", \"bagel\", \"sandwich café\"\n  ],\n  \"Lieferdienste\": [\n    \"lieferdienst\", \"lieferando\", \"uber eats\", \"delivery\", \"zustellung\", \"essen bestellen\", \"lieferung\",\n    \"wolt\", \"deliveroo\", \"just eat\", \"foodora\", \"gorillas\", \"flink\", \"getir\", \"online bestellen\",\n    \"app bestellen\", \"lieferzeit\", \"mindestbestellwert\", \"liefergebühr\", \"kontaktlose lieferung\", \"expresslieferung\",\n    \"hauslieferung\", \"bürolieferung\", \"catering lieferung\", \"meal kit\", \"kochbox\", \"hellofresh\", \"marley spoon\",\n    \"lieferadresse\", \"nachverfolgung\", \"tracking\", \"lieferstatus\", \"bestellung aufgeben\", \"warenkorb\"\n  ],\n  \"Bars\": [\n    \"bar\", \"cocktail\", \"drinks\", \"longdrink\", \"barkeeper\", \"spirituosen\", \"aperitif\", \"happy hour\",\n    \"cocktailbar\", \"weinbar\", \"whiskybar\", \"gin bar\", \"craft beer bar\", \"mixology\", \"bartender\", \"shaker\",\n    \"on the rocks\", \"neat\", \"shot\", \"shooter\", \"digestif\", \"bitters\", \"vermouth\", \"martini\",\n    \"mojito\", \"caipirinha\", \"margarita\", \"moscow mule\", \"old fashioned\", \"negroni\", \"spritz\", \"aperol\",\n    \"barhocker\", \"theke\", \"tresen\", \"zapfhahn\", \"fassbier\", \"flaschenbier\", \"weinprobe\", \"verkostung\"\n  ],\n  \"Clubs\": [\n    \"club\", \"disco\", \"dj\", \"tanzen\", \"nachtleben\", \"party\", \"techno\", \"elektro\", \"nachtclub\",\n    \"nightclub\", \"tanzclub\", \"discotheque\", \"rave\", \"afterhour\", \"clubbing\", \"clubnacht\", \"dancefloor\",\n    \"tanzfläche\", \"vip bereich\", \"bottle service\", \"türsteher\", \"gästeliste\", \"dresscode\", \"eintritt\",\n    \"house musik\", \"edm\", \"hip hop club\", \"latin club\", \"r&b\", \"resident dj\", \"guest dj\", \"lineup\",\n    \"soundsystem\", \"lightshow\", \"stroboskop\", \"nebelmaschine\", \"konfetti\", \"gogo\", \"clubkultur\"\n  ],\n  \"Lounges\": [\n    \"lounge\", \"chillen\", \"entspannen\", \"shisha\", \"hookah\", \"ambient\", \"chill out\", \"lounge musik\",\n    \"shisha bar\", \"shisha lounge\", \"wasserpfeife\", \"tabak\", \"kohle\", \"molasse\", \"shisha cafe\",\n    \"cocktail lounge\", \"hotel lounge\", \"airport lounge\", \"business lounge\", \"vip lounge\", \"sky lounge\",\n    \"gemütlich\", \"sofa\", \"sessel\", \"kissen\", \"gedämpftes licht\", \"kerzen\", \"atmosphäre\", \"ambiente\",\n    \"hintergrundmusik\", \"plaudern\", \"treffen\", \"afterwork\", \"date night\", \"exklusiv\", \"members club\"\n  ],\n  \"Rooftops\": [\n    \"rooftop\", \"dachterrasse\", \"skyline\", \"dachbar\", \"rooftop bar\", \"rooftop restaurant\", \"rooftop lounge\",\n    \"dachgeschoss\", \"aussicht\", \"panorama\", \"stadtblick\", \"sonnenuntergang\", \"sunset\", \"open air bar\",\n    \"terrassenbar\", \"sky bar\", \"high rise\", \"penthouse bar\", \"dachgarten\", \"roof garden\", \"urban gardening\",\n    \"sommernächte\", \"sternenbar\", \"moonlight\", \"outdoor dining\", \"alfresco\", \"sonnenschirm\", \"heizstrahler\",\n    \"blanket\", \"decke\", \"instagram spot\", \"foto location\", \"influencer\", \"trendy\", \"hotspot\"\n  ],\n\n  // =====================================================\n  // FITNESS & SPORT\n  // =====================================================\n  \"Fitness\": [\n    \"fitness\", \"fitnessstudio\", \"gym\", \"training\", \"workout\", \"sport\", \"krafttraining\", \"cardio\", \"muskelaufbau\",\n    \"ausdauer\", \"kondition\", \"bewegung\", \"körper\", \"gesundheit\", \"fit werden\", \"in form kommen\", \"abnehmen\",\n    \"gewicht verlieren\", \"muskeln\", \"definition\", \"bulk\", \"cut\", \"gains\", \"pump\", \"schwitzen\",\n    \"trainingsplan\", \"übungen\", \"wiederholungen\", \"sätze\", \"gewichte\", \"hanteln\", \"langhantel\", \"kurzhantel\",\n    \"kniebeugen\", \"bankdrücken\", \"kreuzheben\", \"klimmzüge\", \"liegestütze\", \"plank\", \"burpees\", \"hiit\"\n  ],\n  \"Fitnessstudios\": [\n    \"fitnessstudio\", \"gym\", \"mcfit\", \"fitness first\", \"john reed\", \"clever fit\", \"gerätetraining\",\n    \"studio\", \"trainingsbereich\", \"freihantelbereich\", \"cardiobereich\", \"kursraum\", \"spinning raum\",\n    \"umkleide\", \"dusche\", \"spind\", \"locker\", \"mitgliedschaft\", \"abo\", \"probetraining\", \"einweisung\",\n    \"geräteeinweisung\", \"trainer\", \"fitnesstrainer\", \"studioleitung\", \"öffnungszeiten\", \"24h fitness\",\n    \"frauen fitness\", \"ladys gym\", \"premium gym\", \"budget gym\", \"boutique gym\", \"crossfit box\"\n  ],\n  \"Yoga & Pilates\": [\n    \"yoga\", \"pilates\", \"meditation\", \"achtsamkeit\", \"asana\", \"yogastudio\", \"yogakurs\", \"stretching\",\n    \"yogamatte\", \"yogablock\", \"yogagurt\", \"yogakissen\", \"meditationskissen\", \"pranayama\", \"atmung\",\n    \"vinyasa\", \"hatha yoga\", \"ashtanga\", \"bikram\", \"hot yoga\", \"yin yoga\", \"kundalini\", \"power yoga\",\n    \"flow\", \"sonnengruß\", \"krieger\", \"herabschauender hund\", \"shavasana\", \"namaste\", \"om\",\n    \"pilates ring\", \"pilates ball\", \"reformer\", \"cadillac\", \"core training\", \"beckenboden\", \"flexibilität\"\n  ],\n  \"Personal Training\": [\n    \"personal trainer\", \"pt\", \"personaltraining\", \"coach\", \"einzeltraining\", \"fitnesstrainer\",\n    \"personal coach\", \"privattrainer\", \"1:1 training\", \"individuelles training\", \"maßgeschneidert\",\n    \"trainingsbetreuung\", \"ernährungsberatung\", \"ernährungsplan\", \"trainingsplan erstellen\", \"zielsetzung\",\n    \"motivation\", \"accountability\", \"fortschrittskontrolle\", \"körperanalyse\", \"inbody\", \"körperfett\",\n    \"muskelanteil\", \"transformation\", \"vorher nachher\", \"success story\", \"bootcamp\", \"outdoor training\",\n    \"hausbesuch\", \"firmentraining\", \"gruppentraining klein\", \"duo training\", \"partner workout\"\n  ],\n  \"Kampfsport\": [\n    \"kampfsport\", \"boxen\", \"mma\", \"karate\", \"judo\", \"kickboxen\", \"taekwondo\", \"selbstverteidigung\", \"jiu jitsu\",\n    \"brazilian jiu jitsu\", \"bjj\", \"muay thai\", \"thaiboxen\", \"kung fu\", \"wing chun\", \"krav maga\",\n    \"aikido\", \"hapkido\", \"capoeira\", \"wrestling\", \"ringen\", \"grappling\", \"submission\", \"sparring\",\n    \"pratzen\", \"sandsack\", \"boxhandschuhe\", \"mundschutz\", \"tiefschutz\", \"schienbeinschoner\", \"kopfschutz\",\n    \"gürtel\", \"dan\", \"kyu\", \"dojo\", \"tatami\", \"ring\", \"käfig\", \"octagon\", \"wettkampf\", \"turnier\"\n  ],\n\n  // =====================================================\n  // GESUNDHEIT & MEDIZIN\n  // =====================================================\n  \"Ärzte\": [\n    \"arzt\", \"praxis\", \"sprechstunde\", \"termin\", \"patient\", \"mediziner\", \"doktor\", \"hausarzt\", \"facharzt\",\n    \"arztpraxis\", \"arzttermin\", \"wartezimmer\", \"behandlung\", \"untersuchung\", \"diagnose\", \"rezept\",\n    \"überweisung\", \"krankschreibung\", \"attest\", \"impfung\", \"vorsorge\", \"check up\", \"gesundheitscheck\",\n    \"blutabnahme\", \"labor\", \"befund\", \"ultraschall\", \"röntgen\", \"ekg\", \"blutdruck\", \"puls\",\n    \"allgemeinmedizin\", \"internist\", \"kardiologe\", \"dermatologe\", \"hno\", \"orthopäde\", \"neurologe\", \"urologe\"\n  ],\n  \"Kliniken\": [\n    \"klinik\", \"krankenhaus\", \"hospital\", \"station\", \"chirurgie\", \"notaufnahme\", \"ambulanz\",\n    \"privatklinik\", \"tagesklinik\", \"fachklinik\", \"reha klinik\", \"spezialklinik\", \"universitätsklinikum\",\n    \"op\", \"operation\", \"eingriff\", \"narkose\", \"intensivstation\", \"bettstation\", \"visite\", \"chefarzt\",\n    \"oberarzt\", \"assistenzarzt\", \"pfleger\", \"krankenschwester\", \"patientenaufnahme\", \"entlassung\",\n    \"krankenhausaufenthalt\", \"stationär\", \"ambulant\", \"notfall\", \"rettungswagen\", \"hubschrauber\"\n  ],\n  \"Augenkliniken\": [\n    \"augenklinik\", \"augenarzt\", \"lasik\", \"augenoperation\", \"sehtest\", \"optiker\", \"brille\", \"kontaktlinsen\",\n    \"augenheilkunde\", \"ophthalmologie\", \"augenärztlich\", \"sehkraft\", \"sehstärke\", \"dioptrien\", \"kurzsichtig\",\n    \"weitsichtig\", \"hornhautverkrümmung\", \"astigmatismus\", \"grauer star\", \"katarakt\", \"grüner star\", \"glaukom\",\n    \"netzhaut\", \"makula\", \"augeninnendruck\", \"augentropfen\", \"femto lasik\", \"smile\", \"prk\", \"icl linsen\",\n    \"linsenimplantation\", \"augenlaserbehandlung\", \"brillenfreiheit\", \"nachuntersuchung\", \"augenlid\"\n  ],\n  \"Therapien\": [\n    \"therapie\", \"physiotherapie\", \"psychotherapie\", \"ergotherapie\", \"rehabilitation\", \"therapeut\", \"behandlung\",\n    \"krankengymnastik\", \"manuelle therapie\", \"lymphdrainage\", \"massage medizinisch\", \"wärmetherapie\", \"kältetherapie\",\n    \"elektrotherapie\", \"ultraschalltherapie\", \"rehasport\", \"funktionstraining\", \"bewegungstherapie\",\n    \"sprachtherapie\", \"logopädie\", \"verhaltenstherapie\", \"gesprächstherapie\", \"traumatherapie\", \"schmerztherapie\",\n    \"heilpraktiker\", \"osteopathie\", \"chiropraktik\", \"akupunktur\", \"naturheilkunde\", \"alternativmedizin\"\n  ],\n\n  // =====================================================\n  // BEAUTY & WELLNESS\n  // =====================================================\n  \"Hair\": [\n    \"friseur\", \"haare\", \"haarschnitt\", \"hairstylist\", \"salon\", \"färben\", \"strähnen\", \"styling\", \"barbershop\",\n    \"friseursalon\", \"haarsalon\", \"coiffeur\", \"hair stylist\", \"haarfarbe\", \"blondierung\", \"balayage\", \"ombre\",\n    \"highlights\", \"lowlights\", \"tönung\", \"dauerwelle\", \"glätten\", \"keratin\", \"extensions\", \"haarverlängerung\",\n    \"trockenschnitt\", \"nassschnitt\", \"waschen schneiden föhnen\", \"föhnen\", \"locken\", \"glätteisen\",\n    \"hochsteckfrisur\", \"brautfrisur\", \"herrenschnitt\", \"fade\", \"undercut\", \"bart trimmen\", \"rasur\", \"barber\"\n  ],\n  \"Nails\": [\n    \"nagelstudio\", \"maniküre\", \"pediküre\", \"nailart\", \"gelnägel\", \"nagellack\", \"nails\",\n    \"nagelpflege\", \"kunstnägel\", \"acrylnägel\", \"shellac\", \"gel polish\", \"uv lampe\", \"led lampe\",\n    \"nagelverlängerung\", \"nagelmodellage\", \"french nails\", \"babyboomer\", \"ombre nails\", \"chrome nails\",\n    \"glitter nails\", \"nail design\", \"nageldesign\", \"stempel\", \"sticker\", \"strass\", \"glitzer\",\n    \"feilen\", \"polieren\", \"nagelhaut\", \"cuticle\", \"hand massage\", \"fuß massage\", \"fußpflege\", \"podologie\"\n  ],\n  \"Brows & Lashes\": [\n    \"augenbrauen\", \"wimpern\", \"lash\", \"brow\", \"microblading\", \"wimpernverlängerung\", \"browbar\",\n    \"lash extensions\", \"wimpernextensions\", \"volume lashes\", \"classic lashes\", \"mega volume\", \"russian volume\",\n    \"wimpernlifting\", \"lash lift\", \"wimpernwelle\", \"wimpernfärben\", \"augenbrauenfärben\", \"brow tinting\",\n    \"augenbrauenform\", \"zupfen\", \"waxing brauen\", \"threading\", \"brow lamination\", \"powder brows\",\n    \"microshading\", \"nano brows\", \"ombre brows\", \"permanentmakeup\", \"pmu\", \"nachbehandlung\", \"auffüllen\"\n  ],\n  \"Medical Beauty\": [\n    \"botox\", \"filler\", \"hyaluron\", \"aesthetik\", \"schönheitschirurgie\", \"lifting\", \"laserbehandlung\", \"anti-aging\",\n    \"hyaluronsäure\", \"lippenunterspritzung\", \"faltenbehandlung\", \"stirnfalten\", \"zornesfalte\", \"krähenfüße\",\n    \"nasolabialfalte\", \"volumenaufbau\", \"wangenaufbau\", \"kinnkorrektur\", \"nasenkorrektur\", \"fadenlifting\",\n    \"ultherapy\", \"thermage\", \"microneedling\", \"prp\", \"vampirlifting\", \"mesotherapie\", \"skinbooster\",\n    \"fruchtsäurepeeling\", \"chemical peel\", \"dermabrasion\", \"laserhaarentfernung\", \"ipl\", \"tattooentfernung\"\n  ],\n  \"Spas\": [\n    \"spa\", \"wellness\", \"massage\", \"sauna\", \"entspannung\", \"beauty\", \"day spa\", \"hamam\",\n    \"wellnesshotel\", \"spa resort\", \"beauty farm\", \"therme\", \"thermalbad\", \"solebad\", \"whirlpool\", \"jacuzzi\",\n    \"dampfbad\", \"dampfsauna\", \"finnische sauna\", \"bio sauna\", \"infrarot sauna\", \"eisbrunnen\", \"ruheraum\",\n    \"entspannungsliege\", \"bademantel\", \"slipper\", \"körperpeeling\", \"body scrub\", \"körperpackung\", \"detox\",\n    \"aromaöl\", \"hot stone\", \"thai massage\", \"ayurveda\", \"lomi lomi\", \"shiatsu\", \"reflexzonenmassage\"\n  ],\n\n  // =====================================================\n  // EVENTS & ERLEBNISSE\n  // =====================================================\n  \"Events & Shows\": [\n    \"event\", \"veranstaltung\", \"eventlocation\", \"feier\", \"party\", \"gala\", \"firmenfeier\",\n    \"firmenevent\", \"corporate event\", \"teambuilding\", \"incentive\", \"kongress\", \"konferenz\", \"tagung\",\n    \"messe\", \"ausstellung event\", \"produktpräsentation\", \"launch event\", \"jubiläum\", \"eröffnung\",\n    \"sommerfest\", \"weihnachtsfeier\", \"betriebsfeier\", \"abschlussfeier\", \"hochzeit\", \"geburtstag\", \"taufe\",\n    \"catering\", \"dekoration\", \"eventplanung\", \"eventmanagement\", \"eventorganisation\", \"moderator\", \"dj event\"\n  ],\n  \"Ausstellungen / Abenteuer\": [\n    \"ausstellung\", \"abenteuer\", \"erlebnis\", \"escape room\", \"lasertag\", \"paintball\", \"freizeitpark\",\n    \"erlebnispark\", \"themenpark\", \"achterbahn\", \"karussell\", \"fahrgeschäft\", \"gruselkabinett\", \"spukhaus\",\n    \"interaktive ausstellung\", \"mitmachausstellung\", \"science center\", \"planetarium\", \"aquarium\", \"zoo\",\n    \"tierpark\", \"kletterpark\", \"hochseilgarten\", \"trampolinhalle\", \"jumphouse\", \"kartbahn\", \"gokart\",\n    \"bowling\", \"minigolf\", \"schwarzlicht minigolf\", \"billard\", \"dart\", \"spielhalle\", \"arcade\"\n  ],\n  \"Workshops / Kunst\": [\n    \"workshop\", \"kurs\", \"seminar\", \"kreativkurs\", \"malkurs\", \"töpfern\", \"handwerk lernen\",\n    \"kreativworkshop\", \"bastelkurs\", \"nähkurs\", \"strickkurs\", \"häkeln\", \"makramee\", \"keramik\", \"porzellan\",\n    \"glaskunst\", \"schmieden\", \"holzarbeiten\", \"tischlerkurs\", \"upcycling\", \"diy workshop\", \"lettering\",\n    \"kalligraphie\", \"aquarell workshop\", \"ölmalerei kurs\", \"zeichenkurs\", \"aktzeichnen\", \"fotokurs\",\n    \"kochkurs\", \"backkurs\", \"barista kurs\", \"cocktailkurs\", \"weinverkostung\", \"gin tasting\", \"whisky tasting\"\n  ],\n  \"VR / AR\": [\n    \"virtual reality\", \"vr\", \"augmented reality\", \"ar\", \"vr brille\", \"immersiv\", \"virtuell\",\n    \"vr erlebnis\", \"vr gaming\", \"vr spiele\", \"vr arcade\", \"vr escape room\", \"vr flugsimulator\",\n    \"vr achterbahn\", \"360 grad\", \"mixed reality\", \"mr\", \"extended reality\", \"xr\", \"metaverse\",\n    \"oculus\", \"htc vive\", \"playstation vr\", \"quest\", \"hologramm\", \"3d erlebnis\", \"simulation\",\n    \"virtuelle welten\", \"avatar\", \"motion tracking\", \"controller\", \"headset\", \"interaktiv digital\"\n  ],\n  \"Outdoor Erlebnisse\": [\n    \"outdoor\", \"wandern\", \"klettern\", \"rafting\", \"paragliding\", \"natur\", \"abenteuer outdoor\", \"survival\",\n    \"trekking\", \"bergsteigen\", \"mountainbike\", \"mtb\", \"downhill\", \"trail\", \"waldwanderung\", \"naturerlebnis\",\n    \"camping\", \"zelten\", \"lagerfeuer\", \"bushcraft\", \"wildnis\", \"orientierung\", \"geocaching\", \"schnitzeljagd\",\n    \"kanufahren\", \"kayak\", \"sup\", \"stand up paddling\", \"segeln\", \"surfen\", \"kitesurfen\", \"tauchen\",\n    \"schnorcheln\", \"canyoning\", \"bungee jumping\", \"fallschirmspringen\", \"gleitschirmfliegen\", \"zipline\"\n  ],\n  \"Saisonale Events (Sommer / Winter)\": [\n    \"sommer event\", \"winter event\", \"weihnachtsmarkt\", \"sommerfest\", \"winterfest\", \"saisonal\",\n    \"frühlingsfest\", \"herbstfest\", \"oktoberfest\", \"volksfest\", \"kirmes\", \"jahrmarkt\", \"stadtfest\",\n    \"straßenfest\", \"weinfest\", \"bierfest\", \"erntedankfest\", \"fasching\", \"karneval\", \"fastnacht\",\n    \"silvester\", \"neujahr\", \"ostern\", \"ostermarkt\", \"pfingsten\", \"maifest\", \"tanz in den mai\",\n    \"sommernachtsfest\", \"open air sommer\", \"beachparty\", \"poolparty\", \"grillparty\", \"gartenparty\"\n  ],\n\n  // =====================================================\n  // LOCATIONS\n  // =====================================================\n  \"Indoor-Locations\": [\n    \"indoor\", \"halle\", \"innenraum\", \"location indoor\", \"veranstaltungshalle\", \"eventhalle\",\n    \"kongresshalle\", \"messehalle\", \"sporthalle\", \"mehrzweckhalle\", \"stadthalle\", \"kulturhalle\",\n    \"festsaal\", \"ballsaal\", \"bankettsaal\", \"konferenzraum\", \"seminarraum\", \"tagungsraum\", \"meetingraum\",\n    \"loft\", \"warehouse\", \"fabrikhalle\", \"industriehalle\", \"atelier location\", \"galerie location\",\n    \"club location\", \"bar location\", \"restaurant privat\", \"separee\", \"gewölbekeller\", \"bunker\"\n  ],\n  \"Outdoor-Locations\": [\n    \"outdoor location\", \"freiluft\", \"open air\", \"biergarten\", \"terrasse\", \"draußen\",\n    \"garten location\", \"parkanlage\", \"schlosspark\", \"botanischer garten\", \"weinberg\", \"strand location\",\n    \"seeufer\", \"flussufer\", \"waldlichtung\", \"wiese\", \"feld\", \"bauernhof\", \"scheune\", \"landgut\",\n    \"weingut\", \"innenhof\", \"atrium\", \"dachgarten location\", \"rooftop event\", \"zelt\", \"festzelt\",\n    \"pavillon\", \"pergola\", \"orangerie\", \"gewächshaus\", \"strandbar\", \"beachclub\"\n  ],\n\n  // =====================================================\n  // SHOPPING & RETAIL\n  // =====================================================\n  \"Einkaufszentren\": [\n    \"einkaufszentrum\", \"shopping mall\", \"mall\", \"shopping center\", \"galeria\", \"kaufhaus\",\n    \"shoppingcenter\", \"einkaufspassage\", \"arkaden\", \"galerie\", \"outlet\", \"factory outlet\", \"designer outlet\",\n    \"shopping meile\", \"fußgängerzone\", \"innenstadt\", \"city\", \"ladenzeile\", \"geschäfte\", \"läden\",\n    \"einzelhandel\", \"retail\", \"flagship store\", \"concept store\", \"pop up store\", \"showroom\",\n    \"food court\", \"gastro meile\", \"parkhaus\", \"tiefgarage\", \"sonntagsverkauf\", \"late night shopping\"\n  ],\n  \"Premium Fashion\": [\n    \"premium\", \"luxus\", \"designer mode\", \"high fashion\", \"haute couture\", \"exklusiv\", \"luxusmarke\",\n    \"luxury\", \"high end\", \"prestige\", \"nobel\", \"erstklassig\", \"premium brand\", \"designerlabel\",\n    \"gucci\", \"prada\", \"louis vuitton\", \"chanel\", \"dior\", \"hermes\", \"burberry\", \"balenciaga\",\n    \"bottega veneta\", \"saint laurent\", \"versace\", \"armani\", \"valentino\", \"fendi\", \"loewe\",\n    \"luxusboutique\", \"flagship\", \"personal shopping\", \"vip service\", \"made to measure\", \"maßanfertigung\"\n  ],\n  \"Streetwear\": [\n    \"streetwear\", \"sneaker\", \"urban\", \"hypebeast\", \"supreme\", \"off-white\", \"streetstyle\",\n    \"urban fashion\", \"street fashion\", \"skate style\", \"hip hop style\", \"casual wear\", \"hoodies\",\n    \"jogginghose\", \"jogger\", \"trainingsanzug\", \"tracksuit\", \"cap\", \"snapback\", \"beanie\",\n    \"nike\", \"adidas\", \"jordan\", \"yeezy\", \"new balance\", \"converse\", \"vans\", \"puma\",\n    \"palace\", \"stussy\", \"bape\", \"kith\", \"fear of god\", \"essentials\", \"limited edition\", \"drop\", \"raffle\"\n  ],\n  \"Second Hand / Vintage\": [\n    \"second hand\", \"vintage\", \"gebraucht\", \"retro\", \"flohmarkt\", \"thrift\",\n    \"secondhand laden\", \"vintage shop\", \"retro boutique\", \"used clothing\", \"pre owned\", \"pre loved\",\n    \"nachhaltig mode\", \"sustainable fashion\", \"circular fashion\", \"upcycled\", \"recycled\", \"öko mode\",\n    \"70er\", \"80er\", \"90er\", \"oldschool\", \"antik\", \"sammlerstück\", \"collector\", \"rare\", \"selten\",\n    \"trödel\", \"antiquitätenladen\", \"kommission\", \"consignment\", \"ankauf verkauf\", \"tauschbörse\"\n  ],\n  \"Designer\": [\n    \"designer\", \"haute couture\", \"modeschöpfer\", \"luxusmode\", \"prêt-à-porter\",\n    \"fashion designer\", \"modedesigner\", \"couturier\", \"atelier mode\", \"kollektion\", \"collection\",\n    \"runway\", \"laufsteg\", \"fashion week\", \"modenschau\", \"catwalk\", \"model\", \"mannequin\",\n    \"schneiderei\", \"maßschneider\", \"bespoke\", \"custom made\", \"handgefertigt\", \"handmade\",\n    \"stoffauswahl\", \"schnittmuster\", \"entwurf\", \"sketch\", \"design\", \"kreation\", \"unikat\", \"einzelstück\"\n  ],\n  \"Schmuck & Juweliere\": [\n    \"schmuck\", \"juwelier\", \"gold\", \"silber\", \"diamant\", \"uhren\", \"accessoires\", \"kette\", \"ring\",\n    \"goldschmied\", \"schmuckgeschäft\", \"juweliergeschäft\", \"edelstein\", \"brillant\", \"rubin\", \"saphir\", \"smaragd\",\n    \"perle\", \"platin\", \"weißgold\", \"roségold\", \"925 silber\", \"sterling\", \"vergoldet\", \"versilbert\",\n    \"armband\", \"armreif\", \"anhänger\", \"ohrring\", \"ohrstecker\", \"creolen\", \"brosche\", \"manschettenknöpfe\",\n    \"verlobungsring\", \"ehering\", \"trauring\", \"gravur\", \"reparatur schmuck\", \"reinigung schmuck\", \"schätzung\"\n  ],\n\n  // =====================================================\n  // RETAIL & STORES\n  // =====================================================\n  \"Interior\": [\n    \"interior\", \"möbel\", \"einrichtung\", \"dekoration\", \"wohndesign\", \"interieur\", \"wohnaccessoires\",\n    \"möbelhaus\", \"einrichtungshaus\", \"wohnstudio\", \"design möbel\", \"designermöbel\", \"sofa\", \"couch\",\n    \"sessel\", \"stuhl\", \"tisch\", \"esstisch\", \"couchtisch\", \"schrank\", \"regal\", \"kommode\", \"bett\",\n    \"matratze\", \"lampe\", \"leuchte\", \"teppich\", \"vorhang\", \"gardine\", \"kissen\", \"decke\", \"vase\",\n    \"bilderrahmen\", \"spiegel\", \"kerze\", \"duftkerze\", \"raumduft\", \"zimmerpflanze\", \"blumentopf\"\n  ],\n  \"Elektronik\": [\n    \"elektronik\", \"technik\", \"smartphone\", \"computer\", \"tablet\", \"gadgets\", \"mediamarkt\", \"saturn\",\n    \"handy\", \"iphone\", \"samsung\", \"laptop\", \"notebook\", \"pc\", \"desktop\", \"monitor\", \"bildschirm\",\n    \"fernseher\", \"tv\", \"smart tv\", \"soundbar\", \"lautsprecher\", \"kopfhörer\", \"airpods\", \"bluetooth\",\n    \"kamera\", \"drohne\", \"spielkonsole\", \"playstation\", \"xbox\", \"nintendo\", \"gaming\", \"zubehör\",\n    \"ladekabel\", \"powerbank\", \"adapter\", \"smart home\", \"alexa\", \"google home\", \"wearables\", \"smartwatch\"\n  ],\n  \"Pflanzen\": [\n    \"pflanzen\", \"blumen\", \"gärtnerei\", \"florist\", \"zimmerpflanzen\", \"garten\", \"blumenladen\",\n    \"blumengeschäft\", \"pflanzencenter\", \"gartencenter\", \"baumschule\", \"stauden\", \"sträucher\", \"bäume\",\n    \"balkonpflanzen\", \"terrassenpflanzen\", \"kübelpflanzen\", \"hängepflanzen\", \"sukkulenten\", \"kakteen\",\n    \"orchideen\", \"rosen\", \"tulpen\", \"schnittblumen\", \"blumenstrauß\", \"gesteck\", \"kranz\", \"trauerfloristik\",\n    \"hochzeitsfloristik\", \"eventfloristik\", \"pflanzenpflege\", \"umtopfen\", \"dünger\", \"erde\", \"topf\", \"übertopf\"\n  ],\n  \"Lifestyle Stores  I Sport\": [\n    \"lifestyle\", \"concept store\", \"sportgeschäft\", \"sportartikel\", \"decathlon\", \"intersport\",\n    \"sports direct\", \"snipes\", \"foot locker\", \"jd sports\", \"sportbekleidung\", \"funktionskleidung\",\n    \"outdoor bekleidung\", \"wanderschuhe\", \"laufschuhe\", \"fußballschuhe\", \"tennisschläger\", \"golfschläger\",\n    \"fahrrad\", \"e-bike\", \"fitness equipment\", \"yogamatte shop\", \"supplements\", \"proteinpulver\",\n    \"lifestyle produkte\", \"trend produkte\", \"design artikel\", \"geschenkartikel\", \"wohlfühlprodukte\"\n  ],\n\n  // =====================================================\n  // TECHNOLOGIE & IT\n  // =====================================================\n  \"IT, Apps & Geräte\": [\n    \"it\", \"software\", \"app\", \"technologie\", \"tech\", \"digital\", \"programmierung\", \"entwickler\", \"startup tech\",\n    \"it firma\", \"softwareentwicklung\", \"webentwicklung\", \"app entwicklung\", \"mobile app\", \"ios\", \"android\",\n    \"saas\", \"cloud\", \"server\", \"hosting\", \"domain\", \"website\", \"webseite\", \"homepage\", \"online\",\n    \"datenbank\", \"api\", \"backend\", \"frontend\", \"ux\", \"ui\", \"design digital\", \"it beratung\", \"it service\",\n    \"it support\", \"helpdesk\", \"systemadministrator\", \"netzwerk\", \"cybersecurity\", \"datenschutz\", \"ki\", \"ai\"\n  ],\n  \"Diverses\": [\n    \"divers\", \"verschiedenes\", \"sonstiges\", \"mixed\", \"allgemein\", \"andere\", \"weitere\", \"übrige\",\n    \"nicht kategorisiert\", \"gemischt\", \"vielfältig\", \"unterschiedlich\", \"mannigfaltig\", \"bunt gemischt\"\n  ],\n\n  // =====================================================\n  // DIENSTLEISTUNGEN\n  // =====================================================\n  \"Creatives\": [\n    \"kreativ\", \"agentur\", \"design\", \"grafikdesign\", \"webdesign\", \"kreativbranche\", \"content creator\",\n    \"kreativagentur\", \"designagentur\", \"werbeagentur\", \"marketingagentur\", \"branding\", \"corporate design\",\n    \"logo design\", \"flyer design\", \"broschüre\", \"katalog\", \"verpackungsdesign\", \"packaging\",\n    \"fotografie\", \"videografie\", \"filmproduktion\", \"animation\", \"motion design\", \"3d design\",\n    \"illustration\", \"infografik\", \"social media content\", \"influencer\", \"blogger\", \"youtuber\", \"content produktion\"\n  ],\n  \"Coaching\": [\n    \"coaching\", \"lifecoach\", \"business coach\", \"beratung\", \"mentoring\", \"persönlichkeitsentwicklung\", \"mindset\",\n    \"coach\", \"trainer\", \"berater\", \"consultant\", \"executive coaching\", \"führungskräfte coaching\", \"karrierecoaching\",\n    \"bewerbungscoaching\", \"jobcoaching\", \"gründercoaching\", \"startup beratung\", \"unternehmensberatung\",\n    \"lebensberatung\", \"systemisches coaching\", \"nlp\", \"hypnose coaching\", \"motivationscoach\", \"erfolgscoach\",\n    \"resilienz\", \"stressmanagement\", \"work life balance\", \"zielerreichung\", \"potenzialentfaltung\", \"selbstfindung\"\n  ],\n  \"Reinigung\": [\n    \"reinigung\", \"putzfirma\", \"gebäudereinigung\", \"cleaning\", \"sauberkeit\", \"putzservice\",\n    \"reinigungsfirma\", \"reinigungsservice\", \"haushaltsreinigung\", \"wohnungsreinigung\", \"büroreinigung\",\n    \"fensterreinigung\", \"glasreinigung\", \"teppichreinigung\", \"polsterreinigung\", \"grundreinigung\",\n    \"unterhaltsreinigung\", \"baureinigung\", \"endreinigung\", \"umzugsreinigung\", \"frühjahrsputz\",\n    \"desinfektion\", \"hygiene\", \"sauber machen\", \"putzen\", \"wischen\", \"staubsaugen\", \"hausmeisterservice\"\n  ],\n  \"Reperatur / Elektronik\": [\n    \"reparatur\", \"werkstatt\", \"instandsetzung\", \"elektronik reparatur\", \"handy reparatur\",\n    \"smartphone reparatur\", \"display reparatur\", \"akku wechsel\", \"iphone reparatur\", \"samsung reparatur\",\n    \"tablet reparatur\", \"laptop reparatur\", \"computer reparatur\", \"pc reparatur\", \"konsolen reparatur\",\n    \"tv reparatur\", \"fernseher reparatur\", \"haushaltsgeräte reparatur\", \"waschmaschine reparatur\",\n    \"kühlschrank reparatur\", \"elektroreparatur\", \"uhrenreparatur\", \"schmuckreparatur\", \"schusterservice\",\n    \"schlüsseldienst\", \"änderungsschneiderei\", \"reparaturcafe\", \"repair cafe\"\n  ],\n\n  // =====================================================\n  // MOBILITÄT\n  // =====================================================\n  \"Autohäuser\": [\n    \"autohaus\", \"autohändler\", \"neuwagen\", \"gebrauchtwagen\", \"autoverkauf\", \"kfz händler\",\n    \"autoverkauf\", \"fahrzeughandel\", \"pkw\", \"auto kaufen\", \"auto verkaufen\", \"inzahlungnahme\",\n    \"probefahrt\", \"leasing\", \"finanzierung\", \"autokredit\", \"fahrzeugfinanzierung\", \"autobank\",\n    \"volkswagen\", \"mercedes\", \"bmw\", \"audi\", \"porsche\", \"ford\", \"opel\", \"toyota\", \"hyundai\",\n    \"kia\", \"skoda\", \"seat\", \"volvo\", \"tesla\", \"elektroauto\", \"hybrid\", \"werkstatt auto\", \"inspektion\"\n  ],\n  \"Carsharing\": [\n    \"carsharing\", \"share now\", \"sixt share\", \"mietwagen\", \"autovermietung\", \"car rental\",\n    \"auto mieten\", \"fahrzeug mieten\", \"kurzeitmiete\", \"stundenmiete\", \"tagesmiete\", \"wochenmiete\",\n    \"miles\", \"flinkster\", \"stadtmobil\", \"cambio\", \"free floating\", \"station based\", \"poolfahrzeug\",\n    \"firmencarsharing\", \"privat carsharing\", \"peer to peer\", \"getaround\", \"turo\", \"snappcar\",\n    \"transporter mieten\", \"lkw mieten\", \"umzugswagen\", \"sprinter mieten\", \"anhänger mieten\"\n  ],\n\n  // =====================================================\n  // IMMOBILIEN & ARBEITEN\n  // =====================================================\n  \"Co-Working\": [\n    \"coworking\", \"co-working\", \"shared office\", \"bürogemeinschaft\", \"flexible arbeitsplätze\", \"wework\",\n    \"coworking space\", \"gemeinschaftsbüro\", \"arbeitsplatz mieten\", \"schreibtisch mieten\", \"desk\",\n    \"hot desk\", \"dedicated desk\", \"private office\", \"team office\", \"meetingraum mieten\", \"konferenzraum mieten\",\n    \"business center\", \"büroservice\", \"virtual office\", \"geschäftsadresse\", \"telefonservice\",\n    \"networking\", \"community\", \"freelancer\", \"startups\", \"gründer\", \"remote work\", \"hybrid work\"\n  ],\n  \"Co-Living\": [\n    \"coliving\", \"co-living\", \"wohngemeinschaft\", \"community living\", \"shared living\",\n    \"gemeinschaftliches wohnen\", \"wg\", \"zusammen wohnen\", \"wohnprojekt\", \"mehrgenerationenhaus\",\n    \"studentenwohnheim\", \"serviced apartment\", \"möbliertes wohnen\", \"temporary living\", \"zwischenmiete\",\n    \"expat wohnung\", \"corporate housing\", \"furnished apartment\", \"all inclusive wohnen\",\n    \"community events\", \"gemeinschaftsküche\", \"gemeinschaftsraum\", \"rooftop gemeinschaft\", \"social living\"\n  ],\n  \"Makler\": [\n    \"makler\", \"immobilien\", \"wohnung\", \"haus kaufen\", \"mieten\", \"immobilienmakler\", \"real estate\",\n    \"immobilienbüro\", \"wohnungsmakler\", \"hausmakler\", \"gewerbeimmobilien\", \"gewerbemakler\",\n    \"wohnung mieten\", \"wohnung kaufen\", \"haus mieten\", \"eigentumswohnung\", \"mietwohnung\", \"kaufimmobilie\",\n    \"besichtigung\", \"exposé\", \"provision\", \"courtage\", \"maklergebühr\", \"kaufvertrag\", \"mietvertrag\",\n    \"notar\", \"grundbuch\", \"finanzierung immobilie\", \"baufinanzierung\", \"hausverwaltung\", \"property management\"\n  ],\n  \"Interior Studios\": [\n    \"interior studio\", \"raumgestaltung\", \"innenarchitektur\", \"einrichtungsberatung\",\n    \"innenarchitekt\", \"interior designer\", \"raumdesign\", \"wohnraumgestaltung\", \"raumkonzept\",\n    \"farbberatung\", \"materialberatung\", \"möbelberatung\", \"lichtplanung\", \"beleuchtungskonzept\",\n    \"home staging\", \"musterwohnung\", \"einrichtungskonzept\", \"wohnberatung\", \"stilberatung wohnen\",\n    \"3d raumplanung\", \"visualisierung\", \"moodboard\", \"stoffmuster\", \"tapetenmuster\", \"bodenbeläge\"\n  ],\n\n  // =====================================================\n  // TOURISMUS & HOSPITALITY\n  // =====================================================\n  \"Hotels & Hospitality\": [\n    \"hotel\", \"unterkunft\", \"übernachtung\", \"rezeption\", \"zimmer\", \"hospitality\", \"pension\", \"hostel\",\n    \"hotelzimmer\", \"suite\", \"einzelzimmer\", \"doppelzimmer\", \"familienzimmer\", \"apartment hotel\",\n    \"boutique hotel\", \"designhotel\", \"luxushotel\", \"businesshotel\", \"stadthotel\", \"wellness hotel\",\n    \"resort\", \"all inclusive\", \"halbpension\", \"vollpension\", \"frühstück inklusive\", \"minibar\",\n    \"roomservice\", \"zimmerservice\", \"concierge\", \"portier\", \"housekeeping\", \"check in\", \"check out\"\n  ],\n  \"Tourismus\": [\n    \"tourismus\", \"reise\", \"urlaub\", \"tourist\", \"sehenswürdigkeit\", \"ausflug\", \"tour\", \"städtereise\",\n    \"stadtführung\", \"guided tour\", \"reiseführer\", \"reiseleiter\", \"tourguide\", \"hop on hop off\",\n    \"sightseeing\", \"besichtigung\", \"rundgang\", \"rundfahrt\", \"bootsfahrt\", \"schifffahrt\", \"kreuzfahrt\",\n    \"pauschalreise\", \"individualreise\", \"backpacking\", \"roadtrip\", \"kurztrip\", \"wochenendtrip\",\n    \"reisebüro\", \"reiseagentur\", \"online reisebüro\", \"buchungsportal\", \"flug buchen\", \"hotel buchen\"\n  ],\n\n  // =====================================================\n  // SONSTIGES\n  // =====================================================\n  \"Straßenumfragen\": [\n    \"umfrage\", \"straßenumfrage\", \"befragung\", \"marktforschung\", \"feedback\",\n    \"meinungsumfrage\", \"kundenbefragung\", \"passantenbefragung\", \"face to face\", \"persönliche befragung\",\n    \"fragebogen\", \"survey\", \"studie\", \"erhebung\", \"datenerhebung\", \"meinungsforschung\", \"demoskopie\",\n    \"stichprobe\", \"proband\", \"incentive umfrage\", \"vergütung umfrage\",\n    \"mystery shopping\", \"testkauf\", \"produkttest\", \"geschmackstest\", \"blindtest\"\n  ],\n  \"Soziales\": [\n    \"sozial\", \"gemeinnützig\", \"ngo\", \"verein\", \"ehrenamt\", \"wohltätigkeit\", \"spende\", \"hilfsorganisation\",\n    \"nonprofit\", \"non profit\", \"charity\", \"stiftung\", \"förderverein\", \"sozialarbeit\", \"sozialpädagogik\",\n    \"jugendhilfe\", \"altenhilfe\", \"behindertenhilfe\", \"obdachlosenhilfe\", \"flüchtlingshilfe\", \"integrationshilfe\",\n    \"tafel\", \"essensausgabe\", \"kleiderkammer\", \"sozialkaufhaus\", \"freiwilligenarbeit\", \"volunteering\",\n    \"spendensammlung\", \"fundraising\", \"benefiz\", \"gala sozial\", \"wohltätigkeitsveranstaltung\"\n  ],\n  \"Winter / Weihnachten\": [\n    \"winter\", \"weihnachten\", \"advent\", \"adventskalender\", \"weihnachtsmarkt\", \"nikolaus\", \"christkind\", \"geschenke\",\n    \"weihnachtsgeschenk\", \"weihnachtsshopping\", \"weihnachtsdeko\", \"weihnachtsbaum\", \"christbaum\", \"tannenbaum\",\n    \"lichterkette\", \"weihnachtskugeln\", \"lametta\", \"kranz\", \"adventskranz\", \"adventskerze\", \"glühwein\",\n    \"kinderpunsch\", \"lebkuchen\", \"spekulatius\", \"stollen\", \"plätzchen\", \"weihnachtsgans\", \"festessen\",\n    \"bescherung\", \"heiligabend\", \"weihnachtsfeiertage\", \"silvester\", \"neujahr\", \"winterzauber\", \"schnee\"\n  ],\n  \"Recruiting\": [\n    \"recruiting\", \"personal\", \"bewerbung\", \"stellenanzeige\", \"job\", \"karriere\", \"hr\", \"headhunter\", \"einstellung\",\n    \"personalvermittlung\", \"arbeitsvermittlung\", \"jobvermittlung\", \"talentakquise\", \"talent acquisition\",\n    \"executive search\", \"direktansprache\", \"active sourcing\", \"bewerbermanagement\", \"applicant tracking\",\n    \"vorstellungsgespräch\", \"interview job\", \"assessment center\", \"eignungstest\", \"persönlichkeitstest\",\n    \"onboarding\", \"einarbeitung\", \"probezeit\", \"arbeitsvertrag\", \"gehaltsverhandlung\", \"employer branding\",\n    \"karriereseite\", \"jobbörse\", \"stepstone\", \"indeed\", \"linkedin\", \"xing\", \"fachkräftemangel\", \"talentpool\"\n  ]\n};\n\n// Alle 66 Branchen als Array\nconst branche_candidates = [\n  \"Kunst\",\"Kino\",\"Fitness\",\"Fine Dining\",\"Casual Dining\",\"Fast Food\",\"Cafés\",\"Lieferdienste\",\n  \"Bars\",\"Clubs\",\"Lounges\",\"Rooftops\",\"Indoor-Locations\",\"Outdoor-Locations\",\"Events & Shows\",\n  \"Ausstellungen / Abenteuer\",\"Workshops / Kunst\",\"VR / AR\",\"Outdoor Erlebnisse\",\n  \"Saisonale Events (Sommer / Winter)\",\"Museen\",\"Theater\",\"Konzerte\",\"Shows / Austellungen\",\n  \"Einkaufszentren\",\"Premium Fashion\",\"Streetwear\",\"Second Hand / Vintage\",\"Designer\",\n  \"Schmuck & Juweliere\",\"Hair\",\"Nails\",\"Brows & Lashes\",\"Medical Beauty\",\"Spas\",\n  \"Fitnessstudios\",\"Yoga & Pilates\",\"Personal Training\",\"Kampfsport\",\"Ärzte\",\"Kliniken\",\n  \"Augenkliniken\",\"Therapien\",\"Interior\",\"Elektronik\",\"Pflanzen\",\"Lifestyle Stores  I Sport\",\n  \"IT, Apps & Geräte\",\"Diverses\",\"Creatives\",\"Coaching\",\"Reinigung\",\"Reperatur / Elektronik\",\n  \"Autohäuser\",\"Carsharing\",\"Co-Working\",\"Co-Living\",\"Makler\",\"Interior Studios\",\n  \"Hotels & Hospitality\",\"Straßenumfragen\",\"Soziales\",\"Tourismus\",\"Winter / Weihnachten\",\"Recruiting\",\n  \"Sonstiges\"\n];\n\n// Gastronomie-Branchen (für spezielle Behandlung)\nconst GASTRO_BRANCHES = [\n  \"Fine Dining\", \"Casual Dining\", \"Fast Food\", \"Cafés\", \"Lieferdienste\", \n  \"Bars\", \"Clubs\", \"Lounges\", \"Rooftops\"\n];\n\n// -----------------------------\n// BRANCHENFILTER LOGIK\n// -----------------------------\nfunction detectBranche(combinedText) {\n  const text = combinedText.toLowerCase();\n  const scores = {};\n  \n  // Initialisiere alle Branchen mit Score 0\n  for (const branche of Object.keys(BRANCHE_KEYWORDS)) {\n    scores[branche] = 0;\n  }\n  \n  // Zähle Keyword-Matches für jede Branche\n  for (const [branche, keywords] of Object.entries(BRANCHE_KEYWORDS)) {\n    for (const keyword of keywords) {\n      // Exakte Wortgrenze-Prüfung für bessere Genauigkeit\n      const regex = new RegExp(`\\\\b${keyword.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}\\\\b`, 'gi');\n      const matches = (text.match(regex) || []).length;\n      if (matches > 0) {\n        // Längere Keywords bekommen höheres Gewicht (spezifischer)\n        const weight = keyword.split(' ').length;\n        scores[branche] += matches * weight;\n      }\n    }\n  }\n  \n  // Sortiere nach Score\n  const sortedBranches = Object.entries(scores)\n    .filter(([_, score]) => score > 0)\n    .sort((a, b) => b[1] - a[1]);\n  \n  // Wenn keine Branche erkannt wurde -> Fallback \"Sonstiges\"\n  if (sortedBranches.length === 0) {\n    return {\n      primary: \"Sonstiges\",\n      fallbacks: [\"Diverses\", \"Straßenumfragen\", \"Soziales\"],\n      confidence: \"none\",\n      scores: {}\n    };\n  }\n  \n  const topBranche = sortedBranches[0][0];\n  const topScore = sortedBranches[0][1];\n  \n  // Bestimme Confidence Level\n  let confidence = \"low\";\n  if (topScore >= 3) confidence = \"medium\";\n  if (topScore >= 5) confidence = \"high\";\n  \n  // Gastronomie nur bei hoher Confidence priorisieren\n  const isGastro = GASTRO_BRANCHES.includes(topBranche);\n  if (isGastro && confidence === \"low\") {\n    // Suche nach nicht-gastronomischen Alternativen mit gleichem oder höherem Score\n    const nonGastroAlternatives = sortedBranches.filter(\n      ([branche, score]) => !GASTRO_BRANCHES.includes(branche) && score >= topScore * 0.7\n    );\n    \n    if (nonGastroAlternatives.length > 0) {\n      // Bevorzuge nicht-gastronomische Branche wenn Score ähnlich\n      return {\n        primary: nonGastroAlternatives[0][0],\n        fallbacks: sortedBranches.slice(0, 5).map(([b, _]) => b).filter(b => b !== nonGastroAlternatives[0][0]),\n        confidence: confidence,\n        scores: Object.fromEntries(sortedBranches.slice(0, 10))\n      };\n    }\n  }\n  \n  // Normale Rückgabe: Top Branche + Fallbacks\n  const fallbacks = sortedBranches\n    .slice(1, 5)\n    .map(([branche, _]) => branche);\n  \n  // Füge verwandte Branchen als Fallbacks hinzu wenn nötig\n  if (fallbacks.length < 3) {\n    fallbacks.push(\"Diverses\", \"Sonstiges\");\n  }\n  \n  return {\n    primary: topBranche,\n    fallbacks: fallbacks.slice(0, 4),\n    confidence: confidence,\n    scores: Object.fromEntries(sortedBranches.slice(0, 10))\n  };\n}\n\n// -----------------------------\n// BRANCHENANALYSE AUSFÜHREN\n// -----------------------------\nconst combinedTxt = `${liveYouText} ${liveThemText} ${memory_context_text} ${memory_topics.join(\" \")}`;\nconst branchenResult = detectBranche(combinedTxt);\n\nconst reference_branche_primary = branchenResult.primary;\nconst reference_branche_fallbacks = branchenResult.fallbacks;\nconst branche_confidence = branchenResult.confidence;\nconst branche_scores = branchenResult.scores;\n\n// -----------------------------\n// Kampagnen-Typ (separiert von Branchen!)\n// -----------------------------\nconst combinedTxtLower = combinedTxt.toLowerCase();\nlet campaign_type = \"standard\";\nif (combinedTxtLower.includes(\"advent\") || combinedTxtLower.includes(\"adventskalender\") || \n    combinedTxtLower.includes(\"weihnacht\") || combinedTxtLower.includes(\"winter\")) {\n  campaign_type = \"adventskalender\";\n}\n\n// -----------------------------\n// Reference Query (dynamisch basierend auf erkannter Branche)\n// -----------------------------\nconst intentHints = [\n  reference_branche_primary,\n  ...reference_branche_fallbacks.slice(0, 2)\n];\n\nconst reference_query = [\n  intentHints.join(\" \"),\n  clip(liveYouText, 140),\n  clip(liveThemText, 120),\n  memory_topics.slice(0, 4).join(\", \")\n].filter(Boolean).join(\" | \").slice(0, 280);\n\nconst ref_context = [\n  `BRANCHE: ${reference_branche_primary}`,\n  `FALLBACKS: ${reference_branche_fallbacks.join(\", \")}`,\n  `CONFIDENCE: ${branche_confidence}`,\n  `TOPICS: ${memory_topics.slice(0,4).join(\", \")}`,\n  `LIVE THEM: ${clip(liveThemText, 180)}`,\n  `LIVE YOU: ${clip(liveYouText, 220)}`,\n  `MEMORY: ${clip(memory_context_text, 260)}`\n].join(\"\\n\").slice(0, 900);\n\n// Filter Kandidaten basierend auf erkannter Branche\nconst reference_filter_candidates = [\n  reference_branche_primary,\n  ...reference_branche_fallbacks\n].filter((v, i, a) => a.indexOf(v) === i); // Deduplizieren\n\nconst branche_hint_text = [\n  liveYouText.slice(0,140),\n  liveThemText.slice(0,140),\n  memory_context_text.slice(0,180)\n].filter(Boolean).join(\" | \");\n\n// -----------------------------\n// OUTPUT\n// -----------------------------\nreturn [{\n  json: {\n    session_id,\n    lead_id,\n    generated_at: new Date().toISOString(),\n    new_run: true,\n\n    // References: Query + Filter Kandidaten\n    reference_query,\n    ref_context,\n    reference_filter_candidates,\n\n    // Branche für Filter (VERBESSERT)\n    branche_candidates,\n    branche_hint_text,\n    branche_confidence,\n    branche_scores,\n\n    // Branchen Fallbacks\n    campaign_type,\n    reference_branche_primary,\n    reference_branche_fallbacks,\n\n    // Agent Inputs\n    live_context_text,\n    memory_context_text,\n    memory_topics,\n\n    // Words\n    words_you,\n    words_them,\n\n    // WPM stable + burst\n    wpm_you,\n    wpm_them,\n    wpm_burst_you,\n    wpm_burst_them,\n\n    // pacing\n    pacing_you,\n    pacing_them,\n\n    // Backwards compat\n    current_wpm: wpm_you,\n    pacing_status: pacing_you,\n\n    // Talk ratio\n    talk_ratio_pct_you,\n    talk_ratio_pct_them,\n\n    // Memory scoring\n    dominates,\n    avg_talk_ratio_you: avg_you,\n\n    // Warnings\n    pacing_warning,\n    talk_ratio_warning,\n    burst_warning,\n\n    // Durations\n    duration_sec,\n    stable_duration_sec: stableDurationSec,\n    burst_duration_sec: burstDurationSec\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        896
      ],
      "id": "8b8dd4eb-ad63-4d9a-bca3-a7459039f9d7",
      "name": "KI-Bremse"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "22618a47-acd5-4d69-8a0a-d7d41ed05205",
              "leftValue": "={{ $json.new_run }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2432,
        896
      ],
      "id": "6f85035f-aedf-4dbd-ad3a-eaff2a5a5837",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n    tip: $json.tip,\n    tip_id: $json.tip_id,\n    tip_type: $json.tip_type || \"general\",\n    confidence: (typeof $json.confidence === \"number\" ? $json.confidence : 0.5),\n    reasoning_mode: $json.reasoning_mode || \"full_llm\",\n    evidence: Array.isArray($json.evidence) ? $json.evidence : [],\n    risk_if_wrong: $json.risk_if_wrong || \"\",\n    warnings: Array.isArray($json.warnings) ? $json.warnings : [],\n\n    sentiment: $json.sentiment || \"neutral\",\n    talk_ratio_warning: !!$json.talk_ratio_warning,\n    pacing_warning: !!$json.pacing_warning,\n\n    current_wpm: $json.current_wpm,\n    pacing_status: $json.pacing_status,\n\n    wpm_you: $json.wpm_you,\n    wpm_them: $json.wpm_them,\n    wpm_burst_you: $json.wpm_burst_you,\n\n    pacing_you: $json.pacing_you,\n    pacing_them: $json.pacing_them,\n\n    talk_ratio_pct_you: $json.talk_ratio_pct_you,\n    talk_ratio_pct_them: $json.talk_ratio_pct_them,\n\n    references: Array.isArray($json.references) ? $json.references.slice(0, 3) : [],\n\n    live_context_text: $json.live_context_text,\n    memory_context_text: $json.memory_context_text,\n    memory_topics: Array.isArray($json.memory_topics) ? $json.memory_topics : [],\n\n    words_you: $json.words_you,\n    words_them: $json.words_them,\n    dominates: $json.dominates,\n    avg_talk_ratio_you: $json.avg_talk_ratio_you,\n\n    feedback_best_tip_type: $json.feedback_best_tip_type || null,\n    feedback_avoid_tip_type: $json.feedback_avoid_tip_type || null,\n    feedback_guidance: $json.feedback_guidance || \"\",\n    feedback_scored_types: Array.isArray($json.feedback_scored_types) ? $json.feedback_scored_types : [],\n    feedback_rows_used: (typeof $json.feedback_rows_used === \"number\" ? $json.feedback_rows_used : null),\n\n    // Lead Info (neu)\n    lead_name: $json.lead_name || null,\n    contact_name: $json.contact_name || null,\n    company_name: $json.company_name || null,\n    city_tag: $json.city_tag || null,\n    industry: $json.industry || null,\n    lead_source: $json.lead_source || null,\n    lead_owner_name: $json.lead_owner_name || null,\n    deal_stage_at_call: $json.deal_stage_at_call || null,\n    avg_response_days: $json.avg_response_days ?? null,\n    email_count: $json.email_count ?? null,\n    notes_count: $json.notes_count ?? null,\n\n    session_id: $json.session_id,\n    lead_id: $json.lead_id,\n    generated_at: $json.generated_at\n  }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        5536,
        592
      ],
      "id": "ceaae652-8e14-4061-97e9-d810295d866a",
      "name": "Respond to Webhook after AI"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n    tip: $json.tip,\n    tip_type: $json.tip_type || \"general\",\n    tip_id: $json.tip_id,\n    confidence: (typeof $json.confidence === \"number\" ? $json.confidence : 0.5),\n    reasoning_mode: $json.reasoning_mode || \"full_llm\",\n    evidence: Array.isArray($json.evidence) ? $json.evidence : [],\n    risk_if_wrong: $json.risk_if_wrong || \"\",\n    warnings: Array.isArray($json.warnings) ? $json.warnings : [],\n\n    sentiment: $json.sentiment || \"neutral\",\n    new_run: !!$json.new_run,\n    generated_at: $json.generated_at,\n\n    pacing_warning: !!$json.pacing_warning,\n    talk_ratio_warning: !!$json.talk_ratio_warning,\n\n    current_wpm: $json.current_wpm,\n    pacing_status: $json.pacing_status,\n\n    wpm_you: $json.wpm_you,\n    wpm_them: $json.wpm_them,\n    wpm_burst_you: $json.wpm_burst_you,\n\n    pacing_you: $json.pacing_you,\n    pacing_them: $json.pacing_them,\n\n    talk_ratio_pct_you: $json.talk_ratio_pct_you,\n    talk_ratio_pct_them: $json.talk_ratio_pct_them,\n\n    words_you: $json.words_you,\n    words_them: $json.words_them,\n\n    dominates: $json.dominates,\n    avg_talk_ratio_you: $json.avg_talk_ratio_you,\n\n    live_context_text: $json.live_context_text,\n    memory_context_text: $json.memory_context_text,\n    memory_topics: Array.isArray($json.memory_topics) ? $json.memory_topics : [],\n\n    references: Array.isArray($json.references) ? $json.references.slice(0, 3) : [],\n\n    feedback_best_tip_type: $json.feedback_best_tip_type || null,\n    feedback_avoid_tip_type: $json.feedback_avoid_tip_type || null,\n    feedback_guidance: $json.feedback_guidance || \"\",\n    feedback_scored_types: Array.isArray($json.feedback_scored_types) ? $json.feedback_scored_types : [],\n    feedback_rows_used: (typeof $json.feedback_rows_used === \"number\" ? $json.feedback_rows_used : null),\n\n    // Lead Info (neu)\n    lead_name: $json.lead_name || null,\n    contact_name: $json.contact_name || null,\n    company_name: $json.company_name || null,\n    city_tag: $json.city_tag || null,\n    industry: $json.industry || null,\n    lead_source: $json.lead_source || null,\n    lead_owner_name: $json.lead_owner_name || null,\n    deal_stage_at_call: $json.deal_stage_at_call || null,\n    avg_response_days: $json.avg_response_days ?? null,\n    email_count: $json.email_count ?? null,\n    notes_count: $json.notes_count ?? null,\n\n    session_id: $json.session_id,\n    lead_id: $json.lead_id\n  }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        5760,
        624
      ],
      "id": "bcb9b91f-78eb-485b-9954-cea7b9f63e39",
      "name": "Respond to Webhook after AI-Break"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "live-stt/bridges",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        608,
        112
      ],
      "id": "dba48e16-2bd7-47e1-a167-e87851332955",
      "name": "Webhook1",
      "webhookId": "6b8701c6-742d-4842-b64c-690190684a8f",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "audio",
        "options": {
          "language": "de"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1024,
        112
      ],
      "id": "7a0cdb43-f8f1-47d1-9002-edf4a1c86c76",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "1RdDoIC8fyMXPQLe",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "9c8bec25-ef03-43d0-bbf0-31b3636d1660",
              "leftValue": "={{$json.tip}}",
              "rightValue": "REPEAT",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4896,
        608
      ],
      "id": "22697934-fe2a-4b55-8993-b447ba8222c5",
      "name": "If1"
    },
    {
      "parameters": {
        "content": "## **BRIDGE WEBHOOK** \n\n- Schickt jeweils 25sek **_Systemaudio_** und **_Mic-Audio_**\n- _**WHISPER**_ transkribiert\n- _**Javascript**_ bereinigt Trainingssätze (Müll) \n- _**Insert**_ neue Gesprächsfetzen in Data Table\n- _**Upsert**_ aktive **session_id** und **ts**\n\n\n\n",
        "height": 208,
        "width": 416,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        560,
        -208
      ],
      "typeVersion": 1,
      "id": "ea4e2351-f1e8-4c34-80f2-7257351c2c11",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "const text = $json.text || \"\";\n\n// Liste der Müll-Sätze\nconst junkPhrases = [\n  \"Amara.org\",\n  \"Vielen Dank fürs Zuschauen\",\n  \"Untertitel von\",\n  \"Untertitel der Amara.org-Community\",\n  \"Amara.org-Community\",\n  \"Untertitelung des ZDF\",\n  \"A. E. A. E. A. E. S. E. S. E. A. E. A. E. A.\",\n  \"Tschüss\",\n  \"Tschüss, bis zum nächsten Mal\",\n  \"Vielen Dank für's Zuschauen\", \n  \"Bis zum nächsten Mal, hau rein\", \n  \"Untertitelung des ZDF\",\n  \"2020\",\n  \"bis zum nächsten Mal\",\n  \"Untertitel der\"\n];\n\n// Check 1: Enthält der Text einen der Müll-Begriffe?\nconst isJunk = junkPhrases.some(phrase => text.includes(phrase));\n\n// Check 2: Ist der Text fast leer oder nur Rauschen?\nconst isTooShort = text.trim().length < 2;\n\n// Wenn Müll oder zu kurz -> Workflow hier stoppen\nif (isJunk || isTooShort) {\n  return [];\n}\n\n// Wenn alles okay -> Daten eins zu eins weiterreichen\nreturn [{ json: $json }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1376,
        112
      ],
      "id": "2ba7d3b2-25e3-4453-bcbc-08faf131a58e",
      "name": "Delete Trash",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "content": "",
        "height": 304,
        "width": 1744,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        560,
        0
      ],
      "typeVersion": 1,
      "id": "3dc519d4-6f85-493d-bc63-0f1f2fc2778a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"active_session_id\": \"{{ $json.active_session_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        5008,
        624
      ],
      "id": "222abb0d-e11a-4f14-afde-76cd80b22d9e",
      "name": "Respond to Webhook new Session ID",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.session_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4384,
        784
      ],
      "id": "dc5c7a56-d448-4c41-a9bf-30dfc6424bc6",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        3616,
        1360
      ],
      "id": "8a28dcb6-d053-4431-b652-6193fa249d52",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "1RdDoIC8fyMXPQLe",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Description: Nutze dieses Tool, um detaillierte Informationen über einen Lead abzurufen. Es enthält Zusammenfassungen aus der E-Mail-Korrespondenz und interne CRM-Notizen. Verwende es für Fragen zu Kundenfeedback, Problemen beim Shooting, Terminabsprachen oder Diskrepanzen zwischen offiziellen Aussagen und interner Dokumentation.",
        "pineconeIndex": {
          "__rl": true,
          "value": "sales-intelligence-1536",
          "mode": "list",
          "cachedResultName": "sales-intelligence-1536"
        },
        "topK": 10,
        "options": {
          "pineconeNamespace": "sales_intelligence_v2",
          "metadata": {
            "metadataValues": [
              {
                "name": "lead_id",
                "value": "={{ $items(\"Webhook GET Endpoint für Overlay\").first().json.query.lead_id }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        4352,
        1072
      ],
      "id": "8afaefba-bb12-4009-94e4-5457d7b53e54",
      "name": "lead_data_search",
      "credentials": {
        "pineconeApi": {
          "id": "WtQEcZxJDwVhbXQi",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        4288,
        1120
      ],
      "id": "89f0f628-39a2-4778-85c6-47f5c73137ec",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "wg8Au3mhQWuwl7vL",
          "name": "OpenAi account sales-intelligence"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "= LIVE CONTEXT:\n  {{ $json.live_context_text }}\n\n PRIOR TIP FEEDBACK (gleicher Lead):\n  {{ $json.prior_tip_feedback_text }}\n\n  METRIKEN:\n  TalkRatioYOU={{ $json.talk_ratio_pct_you }}\n  dominates={{ $json.dominates }}\n  wpm_you={{ $json.wpm_you }}\n  wpm_burst_you={{ $json.wpm_burst_you }}\n  pacing_warning={{ $json.pacing_warning }}\n\n  MEMORY (Kunde):\n  {{ $json.memory_context_text }}\n\n  TOPICS:\n  {{ ($json.memory_topics || []).join(\", \") }}\n\nFEEDBACK LEARNING:\n  {{ $json.feedback_guidance }}\n\n  BEST TIP TYPE:\n  {{ $json.feedback_best_tip_type || \"none\" }}\n\n  AVOID TIP TYPE:\n  {{ $json.feedback_avoid_tip_type || \"none\" }}\n\n  WICHTIG:\n  Wenn AVOID TIP TYPE = \"price\", dann gib \"price\" nur bei explizitem Budget-/Preis-Signal im LIVE CONTEXT aus.\n\n  SESSION FACTS:\n  budget_status={{ $json.session_facts?.budget_status || \"unknown\" }}\n  decision_maker_status={{ $json.session_facts?.decision_maker_status || \"unknown\" }}\n  timeline_status={{ $json.session_facts?.timeline_status || \"unknown\" }}\n  open_objections={{ ($json.session_facts?.open_objections || []).join(\", \") }}\n  next_step_committed={{ $json.session_facts?.next_step_committed || false }}\n\n  LEAD ID (für lead_data_search):\n  {{ $json.lead_id }}\n\n  CAMPAIGN TYPE:\n  {{ $json.campaign_type }}\n\n  LETZTER TIPP (Anti-Repeat):\n  {{ $node[\"Context Packager\"].json.last_tip || \"\" }}\n\n  LETZTER TIPP-TYP:\n  {{ $node[\"Context Packager\"].json.last_tip_type || \"general\" }}\n\n  OUTPUT-REGEL (STRIKT – KEIN AUSNAHME):\n  - tip MUSS exakt Format haben: [MOVE] → [WARUM] → Sag: \"[SKRIPT]\"\n  - GÜLTIG: \"Termin anbieten → Verbindlichkeit erhöht den Abschluss. → Sag: \\\"Können wir Dienstag direkt blockieren?\\\"\"\n  - UNGÜLTIG: \"Nächste Schritte klären\" ← kein Pfeil, kein Sag, nur ein Fragment!\n  - MOVE: max 3 Wörter\n  - WARUM: max 8 Wörter\n  - SKRIPT: max 20 Wörter (1 kurzer natürlicher Satz)\n  - GESAMT: 30 bis 45 Wörter\n  - keine Wiederholung des letzten Tipps",
        "options": {
          "systemMessage": "=### ROLLE & ZIEL\n  Du bist der Live Sales Coach von Viral House.\n  Dein Ziel: in Echtzeit einen konkreten, sofort nutzbaren Move liefern, der den Deal voranbringt.\n  Schreibe kurz, präzise, umsetzbar. Keine Füllwörter.\n\n  ### TOOLS\n  - lead_data_search: Historie/Notizen.\n  Regel:\n  - Wenn lead_id vorhanden und nicht \"unknown_lead\": nutze lead_data_search genau 1x.\n  - Sonst: ohne Tool arbeiten.\n  - Keine weiteren Tools.\n\n  ### OUTPUT (NUR VALIDES JSON)\n  {\n    \"tip\": \"String\",\n    \"tip_type\": \"timing | decision | commit | objection_isolation | price | general\",\n    \"confidence\": 0.0,\n    \"reasoning_mode\": \"pattern_match | full_llm\",\n    \"evidence\": [\n      {\n        \"source\": \"pattern_node | historical_deal | session_fact\",\n        \"id\": \"string\",\n        \"why_relevant\": \"string\"\n      }\n    ],\n    \"risk_if_wrong\": \"string\",\n    \"warnings\": [],\n    \"sentiment\": \"positive | neutral | negative\",\n    \"talk_ratio_warning\": false,\n    \"pacing_warning\": false\n  }\n\n  Regeln:\n  - confidence muss zwischen 0.0 und 1.0 liegen.\n  - evidence muss mindestens 1 Eintrag enthalten.\n  - warnings ist immer ein Array.\n  - AI Agent darf reasoning_mode NICHT auf \"fastlane_rule\" setzen (nur \"pattern_match\" oder \"full_llm\").\n  - Wenn session_facts verwertbar sind: mindestens 1 evidence-Eintrag mit source=\"session_fact\".\n  - Nur JSON ausgeben, ohne zusätzlichen Text.\n  - Nutze session_facts aktiv in WARUM oder SKRIPT.\n  - Wenn alle session_facts unknown/leer sind, nutze stattdessen live_context_text + memory_context_text und setze confidence max. 0.65.\n\n  Wenn budget_status=\"unknown\" UND decision_maker_status=\"unknown\" UND timeline_status=\"unknown\" UND open_objections leer sind, setze confidence zwingend auf maximal 0.65.\n  Wenn diese Regel verletzt wird, ist die Antwort ungültig und muss mit korrigierter confidence neu ausgegeben werden.\n\n  ### FEEDBACK-ADAPTATION (PFLICHT)\n\n  Nutze die Felder `feedback_best_tip_type`, `feedback_avoid_tip_type` und `feedback_guidance` strikt.\n\n  1. Wenn `feedback_best_tip_type` gesetzt ist:\n  - Priorisiere diesen Tip-Typ, solange er zum aktuellen Call-Kontext passt.\n\n  2. Wenn `feedback_avoid_tip_type` gesetzt ist:\n  - Vermeide diesen Tip-Typ standardmäßig.\n  - Ausnahme nur bei klaren Echtzeit-Signalen im aktuellen Kontext.\n  - Für `price` gilt: nur nutzen, wenn ein explizites Budget-/Preis-Signal im LIVE CONTEXT vorkommt\n    (z. B. \"Budget\", \"Preis\", \"Kosten\", \"zu teuer\", \"finanzieren\", \"Euro\").\n\n  3. Konfliktregel:\n  - Wenn `best` und `avoid` gleichzeitig gesetzt sind, hat `avoid` Vorrang, sofern kein starkes Live-Signal dagegen spricht.\n\n  4. Transparenz:\n  - In `evidence` muss mindestens ein Eintrag enthalten sein, der die gewählte Strategie begründet\n    (`source`: `session_fact` oder `pattern_node`).\n\n\n  ### TIP-FORMAT (HART) – KEINE AUSNAHMEN\n\n  ACHTUNG: Ein tip-Wert ohne alle drei Teile ist UNGÜLTIG und wird verworfen.\n\n  UNGÜLTIG (FALSCH): \"Nächste Schritte klären\"\n  UNGÜLTIG (FALSCH): \"Termin anbieten\"\n  UNGÜLTIG (FALSCH): \"Preisrahmen abklären\"\n\n  GÜLTIG (RICHTIG): \"Termin anbieten → Verbindlichkeit erhöht den Abschluss. → Sag: \\\"Können wir direkt nächste Woche Dienstag blockieren?\\\"\"\n  GÜLTIG (RICHTIG): \"Nächsten Schritt klären → Klare Timelines fördern Entscheidungen. → Sag: \\\"Was brauchen Sie noch, um bis Freitag eine Entscheidung zu treffen?\\\"\"\n\n  Format (ZWINGEND):\n  [MOVE] → [WARUM] → Sag: \"[SKRIPT]\"\n\n  Das Zeichen → (Pfeil) MUSS exakt zweimal vorkommen.\n  Das Wort Sag: MUSS vor dem Skript stehen.\n  Das Skript MUSS in doppelten Anführungszeichen stehen.\n\n  Constraints:\n  - MOVE: max 3 Wörter, konkreter Schritt\n  - WARUM: max 8 Wörter, Nutzen oder Grund\n  - SKRIPT: max 20 Wörter, 1 natürlicher gesprochener Satz\n  - Gesamtlänge: 30 bis 45 Wörter\n  - Kein Wiederholen des letzten Tipps\n\n  ### QUALITÄTSKRITERIEN\n  - Klarer nächster Schritt\n  - Natürliches gesprochenes Skript\n  - Kontextbezug aus LIVE CONTEXT + MEMORY + SESSION FACTS\n  - Keine generischen Floskeln\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        4288,
        624
      ],
      "id": "02c5ea25-099e-40b9-a6f7-c2fd1f760781",
      "name": "AI Agent",
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ================================\n// Context Builder (robust, live + replay)\n// ================================\n\nconst WINDOW_SEC = 90;\n\n// 1️⃣ Alle gültigen Timestamps sammeln\nconst allTs = items\n  .map(i => Number(i.json?.ts))\n  .filter(ts => Number.isFinite(ts));\n\nif (!allTs.length) {\n  return [{\n    json: {\n      session_id: \"unknown-session\",\n      context_you: \"\",\n      context_them: \"\",\n      words_you: 0,\n      words_them: 0,\n      talk_ratio_pct_you: 0,\n      talk_ratio_pct_them: 0,\n      duration_sec: WINDOW_SEC,\n      generated_at: new Date().toISOString(),\n      debug: \"no_ts_found\"\n    }\n  }];\n}\n\n// 2️⃣ Referenz-Zeit = neuester Transcript-Timestamp\nconst maxTs = Math.max(...allTs);\nconst windowFrom = maxTs - WINDOW_SEC * 1000;\n\n// Container\nlet sessionId = null;\nlet youTexts = [];\nlet themTexts = [];\nlet wordsYou = 0;\nlet wordsThem = 0;\nlet minTs = null;\nlet usedMaxTs = null;\n\n// Wortzähler\nfunction countWords(t) {\n  return t ? t.trim().split(/\\s+/).filter(Boolean).length : 0;\n}\n\n// 3️⃣ Iteration\nfor (const item of items) {\n  const j = item.json || {};\n  const ts = Number(j.ts);\n\n  if (!Number.isFinite(ts) || ts < windowFrom) continue;\n\n  if (!sessionId && j.session_id) sessionId = j.session_id;\n\n  const text = (j.text || \"\").trim();\n  if (!text) continue;\n\n  const src = (j.source || \"\").toLowerCase();\n\n  let speaker = null;\n  if (src === \"you\" || src === \"y\") speaker = \"you\";\n  if (src === \"customer\") speaker = \"them\";\n  if (!speaker) continue;\n\n  minTs = minTs === null ? ts : Math.min(minTs, ts);\n  usedMaxTs = usedMaxTs === null ? ts : Math.max(usedMaxTs, ts);\n\n  const wc = countWords(text);\n\n  if (speaker === \"you\") {\n    youTexts.push(text);\n    wordsYou += wc;\n  } else {\n    themTexts.push(text);\n    wordsThem += wc;\n  }\n}\n\n// 4️⃣ Dauer\nlet durationSec = WINDOW_SEC;\nif (minTs && usedMaxTs && usedMaxTs > minTs) {\n  durationSec = Math.max(5, Math.round((usedMaxTs - minTs) / 1000));\n}\n\n// 5️⃣ Talk Ratio\nconst totalWords = wordsYou + wordsThem;\nconst pctYou = totalWords ? Math.round((wordsYou / totalWords) * 100) : 0;\nconst pctThem = totalWords ? 100 - pctYou : 0;\n\n// 6️⃣ Output\nreturn [{\n  json: {\n    session_id: sessionId || \"unknown-session\",\n\n    context_you: youTexts.join(\" \").trim(),\n    context_them: themTexts.join(\" \").trim(),\n\n    words_you: wordsYou,\n    words_them: wordsThem,\n\n    talk_ratio_pct_you: pctYou,\n    talk_ratio_pct_them: pctThem,\n\n    duration_sec: durationSec,\n    generated_at: new Date().toISOString(),\n\n    debug_window_from: windowFrom,\n    debug_window_to: maxTs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        832
      ],
      "id": "4a40cc14-48d1-4eab-baa7-86cacf2595f2",
      "name": "Context Builder"
    },
    {
      "parameters": {
        "jsCode": "// ===============================\n// Conversation Memory Builder v1.2\n// Robust (live + replay) + Fallback\n// ===============================\n\nconst WINDOW_MINUTES = 15;\nconst MAX_CHARS = 1200;\nconst FALLBACK_LAST_CUSTOMER_TURNS = 8; // wenn im Window nichts ist\n\nconst all = $input.all();\nif (!all.length) {\n  return [{\n    json: {\n      session_id: null,\n      conversation_context: \"\",\n      customer_topics: [],\n      turns_customer: 0,\n      duration_sec: WINDOW_MINUTES * 60,\n      generated_at: new Date().toISOString(),\n      reason: \"no_items\"\n    }\n  }];\n}\n\nconst sessionId =\n  all.find(i => i.json.session_id)?.json.session_id || \"unknown-session\";\n\nfunction toMs(ts) {\n  if (ts === null || ts === undefined) return null;\n  if (typeof ts === \"number\") return ts;\n  const p = Date.parse(String(ts));\n  return Number.isNaN(p) ? null : p;\n}\n\nfunction isCustomer(src) {\n  const s = String(src || \"\").toLowerCase();\n  return s === \"customer\" || s === \"them\";\n}\n\nconst rows = all\n  .map(i => i.json)\n  .map(t => ({ ...t, ts_ms: toMs(t.ts) }))\n  .filter(t => t.ts_ms !== null)\n  .sort((a, b) => a.ts_ms - b.ts_ms);\n\nif (!rows.length) {\n  return [{\n    json: {\n      session_id: sessionId,\n      conversation_context: \"\",\n      customer_topics: [],\n      turns_customer: 0,\n      duration_sec: WINDOW_MINUTES * 60,\n      generated_at: new Date().toISOString(),\n      reason: \"no_ts_found\"\n    }\n  }];\n}\n\n// Referenz = neuester ts\nconst maxTs = rows[rows.length - 1].ts_ms;\nconst windowFrom = maxTs - WINDOW_MINUTES * 60 * 1000;\n\n// Customer turns im Window\nlet customerTurns = rows\n  .filter(t =>\n    t.ts_ms >= windowFrom &&\n    isCustomer(t.source) &&\n    typeof t.text === \"string\" &&\n    t.text.trim().length > 3\n  );\n\n// Fallback: letzte N customer turns aus der gesamten Session\nlet usedFallback = false;\nif (!customerTurns.length) {\n  const allCustomer = rows.filter(t =>\n    isCustomer(t.source) &&\n    typeof t.text === \"string\" &&\n    t.text.trim().length > 3\n  );\n  if (allCustomer.length) {\n    usedFallback = true;\n    customerTurns = allCustomer.slice(-FALLBACK_LAST_CUSTOMER_TURNS);\n  }\n}\n\nif (!customerTurns.length) {\n  return [{\n    json: {\n      session_id: sessionId,\n      conversation_context: \"\",\n      customer_topics: [],\n      turns_customer: 0,\n      duration_sec: WINDOW_MINUTES * 60,\n      generated_at: new Date().toISOString(),\n      reason: \"no_customer_available\",\n      debug_window_from: windowFrom,\n      debug_window_to: maxTs\n    }\n  }];\n}\n\n// Kontext\nlet contextText = customerTurns\n  .map(t => t.text.trim())\n  .join(\" \")\n  .replace(/\\s+/g, \" \")\n  .trim();\n\n// Kürzen von hinten\nif (contextText.length > MAX_CHARS) {\n  contextText = contextText.slice(-MAX_CHARS);\n}\n\n// Topics\nconst keywords = {};\ncontextText\n  .toLowerCase()\n  .replace(/[^a-zäöüß\\s]/gi, \"\")\n  .split(/\\s+/)\n  .filter(w => w.length > 4)\n  .forEach(w => { keywords[w] = (keywords[w] || 0) + 1; });\n\nconst topTopics = Object.entries(keywords)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 5)\n  .map(([w]) => w);\n\nreturn [{\n  json: {\n    session_id: sessionId,\n    conversation_context: contextText,\n    customer_topics: topTopics,\n    turns_customer: customerTurns.length,\n    duration_sec: WINDOW_MINUTES * 60,\n    generated_at: new Date().toISOString(),\n    used_fallback: usedFallback,\n    debug_window_from: windowFrom,\n    debug_window_to: maxTs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        1008
      ],
      "id": "06781a40-fef8-4871-a631-e4b6a5b83c27",
      "name": "Conversation Memory Builder"
    },
    {
      "parameters": {
        "jsCode": "// ===============================\n  // Context Packager (Live + Memory + Last Tip)\n  // Run once for all items\n  // ===============================\n\n  const MAX_LIVE_CHARS = 900;\n  const MAX_MEMORY_CHARS = 900;\n\n  const all = $input.all().map(i => i.json);\n\n  // Wir erwarten i.d.R. 2 Items: Live Context Builder + Memory Builder\n  const live = all.find(x => x.context_you !== undefined || x.context_them !== undefined) || {};\n  const mem  = all.find(x => x.conversation_context !== undefined) || {};\n\n  function clipTail(s, max) {\n    s = String(s || \"\").trim();\n    if (s.length <= max) return s;\n    return s.slice(-max);\n  }\n\n  function firstNonEmpty(...vals) {\n    for (const v of vals) {\n      if (v !== null && v !== undefined) {\n        const s = String(v).trim();\n        if (s) return s;\n      }\n    }\n    return \"\";\n  }\n\n  function safeNode(pathFn) {\n    try { return pathFn(); } catch (_) { return null; }\n  }\n\n  // Live (YOU/THEM)\n  const liveYou  = clipTail(live.context_you || \"\", Math.floor(MAX_LIVE_CHARS * 0.55));\n  const liveThem = clipTail(live.context_them || \"\", Math.floor(MAX_LIVE_CHARS * 0.45));\n\n  // Memory (Customer)\n  const memoryCustomer = clipTail(mem.conversation_context || \"\", MAX_MEMORY_CHARS);\n\n  // -----------------------------\n  // Lead / Session robust bestimmen\n  // -----------------------------\n  const leadIdFromInputs = all\n    .map(x =>\n      firstNonEmpty(\n        x.lead_id,\n        x.leadId,\n        x.live_context?.lead_id,\n        x.memory_context?.lead_id,\n        x.customer?.lead_id,\n        x.lead?.id\n      )\n    )\n    .find(Boolean);\n\n  const sessionIdFromInputs = all\n    .map(x =>\n      firstNonEmpty(\n        x.session_id,\n        x.sessionId,\n        x.live_context?.session_id,\n        x.memory_context?.session_id\n      )\n    )\n    .find(Boolean);\n\n   const lead_id = firstNonEmpty(\n    safeNode(() => $('Webhook GET Endpoint für Overlay').first().json.query.lead_id),\n    live.lead_id,\n    mem.lead_id,\n    leadIdFromInputs,\n    safeNode(() => $('Webhook1').first().json.body.ID),\n    safeNode(() => $('Get row(s)').first().json.lead_id),\n    safeNode(() => $('Get row(s)').first().json.id)\n  ) || \"unknown_lead\";\n\n  const session_id = firstNonEmpty(\n    live.session_id,\n    mem.session_id,\n    sessionIdFromInputs\n  ) || \"unknown-session\";\n\n  // -----------------------------\n  // ✅ Last Tip aus globalem Cache holen\n  // -----------------------------\n  const staticData = $getWorkflowStaticData('global');\n  const last = staticData.lastTipObj || {};\n\n  const last_tip = last.tip || \"\";\n  const last_tip_type = last.tip_type || \"general\";\n  const last_tip_at = last.generated_at || \"\";\n  const last_tip_hint = last_tip ? String(last_tip).slice(0, 160) : \"\";\n\n  // -----------------------------\n  // Output\n  // -----------------------------\n  return [{\n    json: {\n      session_id,\n      lead_id,\n\n      // Live Context\n      live_context: {\n        you: liveYou,\n        them: liveThem,\n        talk_ratio_pct_you: live.talk_ratio_pct_you ?? null,\n        talk_ratio_pct_them: live.talk_ratio_pct_them ?? null,\n        duration_sec: live.duration_sec ?? null\n      },\n\n      // Memory Context\n      memory_context: {\n        customer: memoryCustomer,\n        topics: mem.customer_topics || [],\n        turns_customer: mem.turns_customer ?? 0,\n        used_fallback: !!mem.used_fallback\n      },\n\n      // Last Tip (für Eskalation / Anti-Repeat)\n      last_tip,\n      last_tip_hint,\n      last_tip_type,\n      last_tip_at,\n\n      generated_at: new Date().toISOString()\n    }\n  }];\n\n$('Webhook GET Endpoint für Overlay').first().json.query.lead_id\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2032,
        896
      ],
      "id": "413a44dc-0051-43ce-bf81-ac7bb83fd8d7",
      "name": "Context Packager"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1824,
        896
      ],
      "id": "dd8178a4-a8e1-4e57-a53c-649e03c4a6ee",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// ===============================\n  // STORE LAST TIP (GLOBAL CACHE) - works for AI + Fastlane paths\n  // ===============================\n\n  const staticData = $getWorkflowStaticData(\"global\");\n  const tipObj = $json || {};\n\n  // Timestamp\n  const timestamp = tipObj.generated_at || new Date().toISOString();\n\n  // Try to read feedback guidance directly from node\n  let fbNode = {};\n  try {\n    fbNode = $node[\"Build Feedback Guidance v1\"].json || {};\n  } catch (_) {\n    fbNode = {};\n  }\n\n  // References: immer exakt 3 Einträge\n  let refs = Array.isArray(tipObj.references) ? tipObj.references.slice(0, 3) : [];\n  refs = refs.map((r, i) => ({\n    name: r?.name || r?.title || `Referenz ${i + 1}`,\n    branche: r?.branche || r?.category || \"\",\n    url: r?.url || r?.link || \"\",\n    why: r?.why || r?.reason || \"\"\n  }));\n  while (refs.length < 3) refs.push({ name: \"\", branche: \"\", url: \"\", why: \"\" });\n\n  // Evidence normalisieren\n  let evidence = Array.isArray(tipObj.evidence) ? tipObj.evidence : [];\n  evidence = evidence\n    .filter((e) => e && typeof e === \"object\")\n    .map((e) => ({\n      source: [\"pattern_node\", \"historical_deal\", \"session_fact\"].includes(e.source) ? e.source : \"historical_deal\",\n      id: String(e.id || \"unknown\"),\n      why_relevant: String(e.why_relevant || \"\")\n    }));\n\n  const warnings = Array.isArray(tipObj.warnings)\n    ? tipObj.warnings.map((w) => String(w))\n    : [];\n\n  // fallback tip_id, falls upstream fehlt\n  const fallbackTipId = `tip_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n\n  // Feedback Felder: Node-Priorität, dann tipObj\n  const feedbackBest = fbNode.feedback_best_tip_type ?? tipObj.feedback_best_tip_type ?? null;\n  const feedbackAvoid = fbNode.feedback_avoid_tip_type ?? tipObj.feedback_avoid_tip_type ?? null;\n  const feedbackGuidance = fbNode.feedback_guidance ?? tipObj.feedback_guidance ?? \"\";\n  const feedbackRowsUsed = Number.isFinite(Number(fbNode.feedback_rows_used))\n    ? Number(fbNode.feedback_rows_used)\n    : (Number.isFinite(Number(tipObj.feedback_rows_used)) ? Number(tipObj.feedback_rows_used) : 0);\n\n  let feedbackScoredRaw = [];\n  if (Array.isArray(fbNode.feedback_scored_types)) feedbackScoredRaw = fbNode.feedback_scored_types;\n  else if (Array.isArray(tipObj.feedback_scored_types)) feedbackScoredRaw = tipObj.feedback_scored_types;\n\n  const feedbackScored = feedbackScoredRaw\n    .filter((x) => x && typeof x === \"object\")\n    .map((x) => ({\n      tip_type: String(x.tip_type || \"general\"),\n      score: Number.isFinite(Number(x.score)) ? Number(x.score) : 0,\n      helpful: Number.isFinite(Number(x.helpful)) ? Number(x.helpful) : 0,\n      harmful: Number.isFinite(Number(x.harmful)) ? Number(x.harmful) : 0,\n      won: Number.isFinite(Number(x.won)) ? Number(x.won) : 0,\n      neutral: Number.isFinite(Number(x.neutral)) ? Number(x.neutral) : 0,\n      total: Number.isFinite(Number(x.total)) ? Number(x.total) : 0\n    }));\n\n  \n  // Lead Profile aus Pinecone (load lead profile node)\n  let leadProfile = {};\n  try {\n    const lp = tipObj.lead_profile;\n    if (lp && typeof lp === \"object\") leadProfile = lp;\n  } catch (_) {}\n\n  // ---- STORE ----\n  staticData.lastTipObj = {\n    tip: tipObj.tip || \"Kein Tipp...\",\n    tip_type: tipObj.tip_type || \"general\",\n    confidence: (typeof tipObj.confidence === \"number\" ? Math.max(0, Math.min(1, tipObj.confidence)) : 0.5),\n    reasoning_mode: tipObj.reasoning_mode || \"full_llm\",\n    evidence,\n    risk_if_wrong: tipObj.risk_if_wrong || \"\",\n    warnings,\n\n    sentiment: tipObj.sentiment || \"neutral\",\n    new_run: true,\n\n    references: refs,\n\n    reference_query: tipObj.reference_query || \"\",\n    ref_context: tipObj.ref_context || \"\",\n\n    talk_ratio_warning: !!tipObj.talk_ratio_warning,\n    pacing_warning: !!tipObj.pacing_warning,\n\n    current_wpm: tipObj.current_wpm ?? null,\n    pacing_status: tipObj.pacing_status ?? \"n/a\",\n\n    wpm_you: tipObj.wpm_you ?? null,\n    wpm_them: tipObj.wpm_them ?? null,\n    wpm_burst_you: tipObj.wpm_burst_you ?? null,\n\n    pacing_you: tipObj.pacing_you ?? \"n/a\",\n    pacing_them: tipObj.pacing_them ?? \"n/a\",\n\n    talk_ratio_pct_you: tipObj.talk_ratio_pct_you ?? null,\n    talk_ratio_pct_them: tipObj.talk_ratio_pct_them ?? null,\n\n    words_you: tipObj.words_you ?? 0,\n    words_them: tipObj.words_them ?? 0,\n\n    dominates: tipObj.dominates || \"balanced\",\n    avg_talk_ratio_you: tipObj.avg_talk_ratio_you ?? null,\n\n    live_context_text: tipObj.live_context_text || \"\",\n    memory_context_text: tipObj.memory_context_text || \"\",\n    memory_topics: Array.isArray(tipObj.memory_topics) ? tipObj.memory_topics : [],\n\n    // Feedback debug fürs Overlay\n    feedback_best_tip_type: feedbackBest,\n    feedback_avoid_tip_type: feedbackAvoid,\n    feedback_guidance: String(feedbackGuidance || \"\"),\n    feedback_scored_types: feedbackScored,\n    feedback_rows_used: feedbackRowsUsed,\n\n    session_id: tipObj.session_id || null,\n    lead_id: tipObj.lead_id || \"unknown_lead\",\n    generated_at: timestamp,\n    tip_id: tipObj.tip_id || fallbackTipId,\n\n    // Lead Profile (nested + flat für Overlay-Kompatibilität)\n    lead_profile: {\n      lead_name: leadProfile.lead_name ?? tipObj.lead_name ?? null,\n      contact_name: leadProfile.contact_name ?? tipObj.contact_name ?? null,\n      company_name: leadProfile.company_name ?? tipObj.company_name ?? null,\n      city_tag: leadProfile.city_tag ?? tipObj.city_tag ?? null,\n      industry: leadProfile.industry ?? tipObj.industry ?? null,\n      lead_source: leadProfile.lead_source ?? tipObj.lead_source ?? null,\n      lead_owner_name: leadProfile.lead_owner_name ?? tipObj.lead_owner_name ?? null,\n      deal_stage_at_call: leadProfile.deal_stage_at_call ?? tipObj.deal_stage_at_call ?? null,\n      avg_response_days: leadProfile.avg_response_days ?? tipObj.avg_response_days ?? null,\n      email_count: leadProfile.email_count ?? tipObj.email_count ?? null,\n      notes_count: leadProfile.notes_count ?? tipObj.notes_count ?? null\n    },\n    lead_profile_debug: tipObj.lead_profile_debug || null,\n    lead_name: leadProfile.lead_name ?? tipObj.lead_name ?? null,\n    contact_name: leadProfile.contact_name ?? tipObj.contact_name ?? null,\n    company_name: leadProfile.company_name ?? tipObj.company_name ?? null,\n    city_tag: leadProfile.city_tag ?? tipObj.city_tag ?? null,\n    industry: leadProfile.industry ?? tipObj.industry ?? null,\n    lead_source: leadProfile.lead_source ?? tipObj.lead_source ?? null,\n    lead_owner_name: leadProfile.lead_owner_name ?? tipObj.lead_owner_name ?? null,\n    deal_stage_at_call: leadProfile.deal_stage_at_call ?? tipObj.deal_stage_at_call ?? null,\n    avg_response_days: leadProfile.avg_response_days ?? tipObj.avg_response_days ?? null,\n    email_count: leadProfile.email_count ?? tipObj.email_count ?? null,\n    notes_count: leadProfile.notes_count ?? tipObj.notes_count ?? null,\n\n    // Session Facts\n    session_facts: tipObj.session_facts ?? null,\n\n    // Burst (both speakers)\n    wpm_burst_them: tipObj.wpm_burst_them ?? null\n  };\n\n  return [\n    {\n      json: {\n        status: \"stored\",\n        ...staticData.lastTipObj\n      }\n    }\n  ];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5184,
        592
      ],
      "id": "f1557bb2-d9d3-44df-a2c9-5d57200a1185",
      "name": "Store in Cache"
    },
    {
      "parameters": {
        "jsCode": "// ===============================\n// RETURN CACHED TIP (new_run=false)\n// ===============================\n\nconst staticData = $getWorkflowStaticData('global');\n\n// Wenn noch nichts gecached ist: sauberes Default Objekt\nif (!staticData.lastTipObj) {\n  return [{\n    json: {\n      tip: \"Analysiere...\",\n      sentiment: \"neutral\",\n      new_run: false,\n      generated_at: new Date().toISOString(),\n\n      pacing_warning: false,\n      talk_ratio_warning: false,\n\n      current_wpm: null,\n      pacing_status: \"n/a\",\n\n      wpm_you: null,\n      wpm_them: null,\n      wpm_burst_you: null,\n\n      pacing_you: \"n/a\",\n      pacing_them: \"n/a\",\n\n      talk_ratio_pct_you: null,\n      talk_ratio_pct_them: null,\n\n      words_you: 0,\n      words_them: 0,\n\n      dominates: \"balanced\",\n      avg_talk_ratio_you: null,\n\n      live_context_text: \"\",\n      memory_context_text: \"\",\n      memory_topics: [],\n\n      references: [\n        { name: \"\", branche: \"\", url: \"\", why: \"\" },\n        { name: \"\", branche: \"\", url: \"\", why: \"\" },\n        { name: \"\", branche: \"\", url: \"\", why: \"\" }\n      ],\n\n      session_id: $json.session_id || null,\n      lead_id: $json.lead_id || null, \n      tip_id: last.tip_id || null\n    }\n  }];\n}\n\n// Normalfall: Cache ausgeben, aber new_run auf false setzen\nreturn [{\n  json: {\n    ...staticData.lastTipObj,\n    new_run: false\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        880
      ],
      "id": "fefb5f6e-9881-4b84-bf36-fb907fe6ab78",
      "name": "Cache Return Node"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ec92a841-61ec-42df-9d99-7f4d5cb9af93",
              "name": "session_id",
              "value": "={{ $json.query.session_id || '' }}",
              "type": "string"
            },
            {
              "id": "ffe4642a-b622-475c-adda-91a6844c436b",
              "name": "action",
              "value": "={{ $json.query.action || 'auto' }}",
              "type": "string"
            },
            {
              "id": "52467d5a-fd9c-48f4-ae06-9f3ee4a39a47",
              "name": "lead_id",
              "value": "={{ $json.query.lead_id || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        848,
        672
      ],
      "id": "8ec10571-d3ff-4f8a-8926-d4c0407bb33e",
      "name": "Normalize Query"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ !!$json.session_id && $json.session_id !== '' }}",
                    "rightValue": "={{ !!$json.session_id && $json.session_id !== '' }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "9d432db4-1098-4558-9347-ad9b5756aea7"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "57474d39-266a-4696-8d8f-86dc15cdbb5a",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "get_active_session",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1264,
        768
      ],
      "id": "0e1fce6b-c3d0-4c57-a64c-97df0ec669b0",
      "name": "Switch1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        2736,
        608
      ],
      "id": "b97f0e90-8c45-41bf-b861-8ff3280fad96",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "wg8Au3mhQWuwl7vL",
          "name": "OpenAi account sales-intelligence"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.session_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        2784,
        464
      ],
      "id": "464227ed-83e3-438b-a62c-3ef923fb0808",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Hier findest du ALLE REFERENZEN, passend zu den 66 Branchen - gib mindestens 3 passende Referenzen zurück",
        "pineconeIndex": {
          "__rl": true,
          "value": "sales-intelligence-1536",
          "mode": "list",
          "cachedResultName": "sales-intelligence-1536"
        },
        "topK": 6,
        "options": {
          "pineconeNamespace": "references",
          "metadata": {
            "metadataValues": [
              {
                "name": "=branche",
                "value": "={{ $json.reference_branche_primary }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        2752,
        368
      ],
      "id": "d01e5355-2b48-4d61-b3a6-c3cd01d8dc2a",
      "name": "Referenzen",
      "credentials": {
        "pineconeApi": {
          "id": "WtQEcZxJDwVhbXQi",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        3088,
        464
      ],
      "id": "b7b47b6f-dc3f-4cf2-9470-bfe745215c5a",
      "name": "Embeddings OpenAI3",
      "credentials": {
        "openAiApi": {
          "id": "wg8Au3mhQWuwl7vL",
          "name": "OpenAi account sales-intelligence"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"erklärung\": \"Diese Branche habe ich gewählt, weil... [Erklärung zur Auswahl der Branche basierend auf dem Gesprächsverlauf und Kontext]\",\n  \"branche\": \"Outdoor-Locations\", \n  \"referenzen\": [\n    {\n      \"name\": \"Rooftop Bar XYZ\",\n      \"beschreibung\": \"Perfekte Location für Sommer-Events mit Blick auf die Stadt.\",\n      \"link\": \"https://instagram.com/rooftopbarxyz\"\n    },\n    {\n      \"name\": \"Sky Lounge ABC\",\n      \"beschreibung\": \"Eine exklusive Rooftop-Location für Events und Feiern.\",\n      \"link\": \"https://instagram.com/skyloungeabc\"\n    }\n  ],\n  \"links\": [\n    \"https://instagram.com/rooftopbarxyz\",\n    \"https://instagram.com/skyloungeabc\"\n  ]\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2880,
        544
      ],
      "id": "641526dc-2a2e-46f2-ae2e-25ff4a26152e",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify([$json]) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        3696,
        176
      ],
      "id": "07bd9fb4-6ce5-4e27-89fc-11a8890c3abe",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// -----------------------------\n// Referenzen normalisieren + deduplizieren (genau 3) + Erklärung\n// -----------------------------\nconst output = $input.item.json.output || {};\nconst branche = output.branche || \"\";\nlet refs = output.referenzen;\nif (!Array.isArray(refs)) refs = [];\n\n// normalisieren MIT DEN FELDNAMEN DIE DAS OVERLAY ERWARTET\nrefs = refs.map((r, i) => ({\n  name: (r?.name || `Referenz ${i + 1}`).toString(),\n  branche: (r?.branche || branche).toString(),\n  link: (r?.link || r?.url || \"\").toString(),\n  beschreibung: (r?.beschreibung || r?.why || \"\").toString()\n}));\n\n// dedup\nconst seen = new Set();\nrefs = refs.filter(r => {\n  const key = (r.link && r.link.trim())\n    ? `url:${r.link.trim().toLowerCase()}`\n    : `nb:${(r.name || \"\").trim().toLowerCase()}|${(r.branche || \"\").trim().toLowerCase()}`;\n  if (seen.has(key)) return false;\n  seen.add(key);\n  return true;\n});\n\n// exakt 3 Referenzen\nrefs = refs.slice(0, 3);\nwhile (refs.length < 3) {\n  refs.push({ name: \"\", branche: \"\", link: \"\", beschreibung: \"\" });\n}\n\n// ERKLÄRUNG extrahieren (mit Fallback)\nconst erklaerung = output.erklärung || output.erklaerung || \"\";\n\n// Rückgabe für Webhook (Array im response-Feld)\nreturn [{\n  json: {\n    references: refs,\n    erklärung: erklaerung\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3168,
        176
      ],
      "id": "a180683d-903b-46f5-acb4-53109fe20bf7",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook GET Endpoint für Overlay').first().json.query.action }}",
                    "rightValue": "=get_refs",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8e48329e-98e6-4c01-abd6-1f085bd20730"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "7ce4b943-ad4a-4b47-bfe9-d7332cca824a",
                    "leftValue": "={{ $('Webhook GET Endpoint für Overlay').first().json.query.action }}",
                    "rightValue": "get_refs",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2416,
        624
      ],
      "id": "77ffe2c6-a28d-4b1e-9c7c-1d639f32c0ac",
      "name": "Switch2"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "zbIbJ2bU57N14DBp",
          "mode": "list",
          "cachedResultName": "sales_intelligence_session_facts",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/zbIbJ2bU57N14DBp"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "keyValue": "={{ $json.session_facts.session_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "next_step_committed": "={{ !!$json.session_facts.next_step_committed }}",
            "session_id": "={{ $json.session_id }}",
            "lead_id": "={{ $json.lead_id }}",
            "budget_status": "={{ $json.session_facts.budget_status }}",
            "decision_maker_status": "={{ $json.session_facts.decision_maker_status }}",
            "timeline_status": "={{ $json.session_facts.timeline_status }}",
            "competitors": "={{ ($json.session_facts.competitors || []).join('; ') }}",
            "open_objections": "={{ ($json.session_facts.open_objections || []).join('; ') }}",
            "resolved_objections": "={{ ($json.session_facts.resolved_objections || []).join('; ') }}",
            "updated_at": "= {{ $json.generated_at || new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "budget_status",
              "displayName": "budget_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "decision_maker_status",
              "displayName": "decision_maker_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "timeline_status",
              "displayName": "timeline_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "competitors",
              "displayName": "competitors",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "open_objections",
              "displayName": "open_objections",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "resolved_objections",
              "displayName": "resolved_objections",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "next_step_committed",
              "displayName": "next_step_committed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2528,
        1152
      ],
      "id": "bd36d7ac-0078-4b05-930c-a830066fe7e2",
      "name": "Upsert Session Facts"
    },
    {
      "parameters": {
        "jsCode": "const j = $json || {};\n\n  function s(v) { return String(v || \"\").trim(); }\n  function hasAny(text, arr) {\n    const t = s(text).toLowerCase();\n    return arr.some(x => t.includes(x));\n  }\n\n  const liveText = [s(j.live_context_text), s(j.memory_context_text)].join(\" \").toLowerCase();\n\n  const budget_status =\n    hasAny(liveText, [\"budget frei\", \"freigegeben\", \"budget passt\", \"genehmigt\"]) ? \"approved\" :\n    hasAny(liveText, [\"kein budget\", \"zu teuer\", \"budgetproblem\", \"budget knapp\"]) ? \"constrained\" :\n    hasAny(liveText, [\"budget\", \"preis\", \"kosten\"]) ? \"mentioned\" :\n    \"unknown\";\n\n  const decision_maker_status =\n    hasAny(liveText, [\"entscheider\", \"geschäftsführer\", \"ceo\", \"inhaber\"]) ? \"identified\" :\n    hasAny(liveText, [\"muss intern klären\", \"nicht entscheidungsbefugt\", \"chef nicht da\"]) ? \"not_present\" :\n    \"unknown\";\n\n  const timeline_status =\n    hasAny(liveText, [\"diese woche\", \"sofort\", \"dringend\", \"morgen\"]) ? \"urgent\" :\n    hasAny(liveText, [\"nächsten monat\", \"später\", \"verschieben\", \"in 1-2 monaten\"]) ? \"delayed\" :\n    hasAny(liveText, [\"timeline\", \"zeitplan\", \"wann\"]) ? \"mentioned\" :\n    \"unknown\";\n\n  const competitorHints = [\"konkurrent\", \"andere agentur\", \"vergleich\", \"angebot von\", \"wettbewerber\"];\n  const competitors = competitorHints.filter(k => liveText.includes(k));\n\n  const objectionMap = [\n    { key: \"price\", terms: [\"zu teuer\", \"preis\", \"budget\"] },\n    { key: \"timing\", terms: [\"kein zeit\", \"später\", \"verschieben\", \"timing\"] },\n    { key: \"trust\", terms: [\"unsicher\", \"vertrauen\", \"referenzen\"] },\n    { key: \"authority\", terms: [\"muss abklären\", \"entscheider fehlt\"] },\n    { key: \"competitor\", terms: [\"wettbewerber\", \"andere agentur\"] },\n    { key: \"no_need\", terms: [\"kein bedarf\", \"brauchen wir nicht\"] }\n  ];\n\n  const open_objections = objectionMap\n    .filter(o => hasAny(liveText, o.terms))\n    .map(o => o.key);\n\n  const next_step_committed = hasAny(liveText, [\n    \"termin steht\", \"ich schicke dir\", \"wir machen fest\", \"nächster termin\", \"kalender\"\n  ]);\n\n  return [{\n    json: {\n      ...j,\n      session_facts: {\n        session_id: j.session_id || null,\n        lead_id: j.lead_id || \"unknown_lead\",\n        budget_status,\n        decision_maker_status,\n        timeline_status,\n        competitors,\n        open_objections,\n        resolved_objections: [],\n        next_step_committed\n      }\n    }\n  }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2304,
        1152
      ],
      "id": "678d828f-f816-4618-9898-346ded584095",
      "name": "Extract Session Facts v1"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "zbIbJ2bU57N14DBp",
          "mode": "list",
          "cachedResultName": "sales_intelligence_session_facts",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/zbIbJ2bU57N14DBp"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "session_id",
              "keyValue": "={{ $json.session_id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        2752,
        1152
      ],
      "id": "33f9400b-18ee-4c5a-9837-41137e40af7a",
      "name": "Load Session Facts"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 3,
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2976,
        784
      ],
      "id": "e1dc2f8e-84cf-44ed-842f-c9dc7412417e",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "  const base = $json || {};\n  let facts = {};\n  try {\n    facts = $('Load Session Facts').first().json || {};\n  } catch (_) {\n    facts = {};\n  }\n  return [{ json: { ...base, session_facts: facts } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        1152
      ],
      "id": "985cabc1-071a-4ebc-9f2f-48c787a0f42a",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Hier ist der Gesprächsverlauf: [{{ $json.live_context_text }} {{ $json.memory_context_text }}].\n\nHier das, was mein JavaScript bereits aus dem Gespräch analysieren konnte:  {{ $json.reference_query }}{{ $json.ref_context }}\n\nBerechnete Referenzbranche + Score (Primary): {{ $json.reference_branche_primary }} {{ $json.branche_scores['Straßenumfragen'] }}\nFallbacks: {{ $json.reference_branche_fallbacks }}\n\nMemory Topics: {{ $json.memory_topics }}\n\n\nUND DU MUSST AUS EINER PINECONE DATENBANK PASSENDE REFERENZEN RAUSSUCHEN (Tool = \"Referenzen\")\n\nNutze das Tool GENAU 1x Pro Anfrage!\n\nFeld reference_branche:\nWähle zwingend EINE Branche exakt aus dieser Liste:\n(66 möglichen Branchen: {{ $json.branche_candidates }}\n(Wenn unsicher -> \"Diverses\")\n\nReferenz-Auswahl:\n\n* Wähle die Top 3 Treffer.\n* Keine Duplikate (URL checken).\n* url = metadata.link (Fallback: metadata.text).\n* why = 1 kurzer Satz (Sales-Argument).\n* Falls Tool leer: Sende leeres Array-Objekt, aber halte JSON-Struktur ein.\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=Du bist der Referenz-Analyst für Sales-Calls.\n\n  AUFGABE\n  - Bestimme die bestpassende Branche aus der festen 66er-Referenzliste.\n  - Nutze dafür IMMER das Tool \"Referenzen\" (Pinecone), um passende Referenzsignale zu prüfen.\n  - Verlasse dich NICHT blind auf vorab berechnete Code-Felder.\n  - Triff immer eine eindeutige Auswahl.\n  - Wenn wirklich keine Branche passt, verwende den Fallback \"Diverses\".\n\n  WICHTIGE REGELN\n  1. Du musst zuerst den Gesprächskontext analysieren (Keywords, Problem, Angebot, Ziel, Einwände).\n  2. Dann musst du mit Tool \"Referenzen\" verifizieren, welche Branche semantisch am besten passt.\n  3. Gib nur eine Branche zurück (keine Liste, keine Mehrfachauswahl).\n  4. Wenn mehrere Branchen ähnlich wirken, nimm die mit der höchsten inhaltlichen Übereinstimmung zu Problem + Kaufkontext.\n  5. Antworte AUSSCHLIESSLICH als valides JSON. Kein Fließtext außerhalb von JSON.\n\n  AUSGABE-FORMAT (STRICT JSON ONLY)\n  {\n    \"branche\": \"String - exakt ein Branchenname\",\n    \"confidence\": 0.0,\n    \"reasoning_mode\": \"pattern_match\",\n    \"evidence\": [\n      {\n        \"source\": \"historical_deal\",\n        \"id\": \"string\",\n        \"why_relevant\": \"string\"\n      }\n    ],\n    \"why\": \"Kurze Begründung in 1-2 Sätzen\"\n  }\n\n  VALIDIERUNG\n  - confidence muss zwischen 0.0 und 1.0 liegen.\n  - evidence muss mindestens 1 Eintrag enthalten.\n  - branche darf nicht leer sein.\n  - Wenn unklar: branche = \"Diverses\".\n\n  ZULÄSSIGE BRANCHEN (EXAKTE SCHREIBWEISE)\n  Kunst\n  Kino\n  Fitness\n  Fine Dining\n  Casual Dining\n  Fast Food\n  Cafés\n  Lieferdienste\n  Bars\n  Clubs\n  Lounges\n  Rooftops\n  Indoor-Locations\n  Outdoor-Locations\n  Events & Shows\n  Ausstellungen / Abenteuer\n  Workshops / Kunst\n  VR / AR\n  Outdoor Erlebnisse\n  Saisonale Events (Sommer / Winter)\n  Museen\n  Theater\n  Konzerte\n  Shows / Ausstellungen\n  Einkaufszentren\n  Premium Fashion\n  Streetwear\n  Second Hand / Vintage\n  Designer\n  Schmuck & Juweliere\n  Hair\n  Nails\n  Brows & Lashes\n  Medical Beauty\n  Spas\n  Fitnessstudios\n  Yoga & Pilates\n  Personal Training\n  Kampfsport\n  Ärzte\n  Kliniken\n  Augenkliniken\n  Therapien\n  Interior\n  Elektronik\n  Pflanzen\n  Lifestyle Stores I Sport\n  IT, Apps & Geräte\n  Diverses\n  Creatives\n  Coaching\n  Reinigung\n  Reperatur / Elektronik\n  Autohäuser\n  Carsharing\n  Co-Working\n  Co-Living\n  Makler\n  Interior Studios\n  Hotels & Hospitality\n  Straßenumfragen\n  Soziales\n  Tourismus\n  Winter / Weihnachten\n  Recruiting\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        2736,
        176
      ],
      "id": "7bbd6c3f-63ee-43a6-8cda-2547b2541f05",
      "name": "AI Agent Referenzanalyst"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6abe899b-2da4-4846-9614-7392053c3c34",
              "leftValue": "={{ $json.fastlane_hit }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3104,
        1600
      ],
      "id": "52b45d96-12ba-4945-a979-19bdd7a34275",
      "name": "If2"
    },
    {
      "parameters": {
        "jsCode": "const j = $json || {};\n  const baseText = [\n    j.live_context_text || \"\",\n    j.memory_context_text || \"\",\n    j.live_context?.you || \"\",\n    j.live_context?.them || \"\"\n  ].join(\" \").toLowerCase();\n\n  function findMatches(arr) {\n    const hits = arr.filter(k => baseText.includes(String(k).toLowerCase()));\n    return hits;\n  }\n\n  const priceKeys = [\"zu teuer\", \"preis\", \"budget\", \"kosten\"];\n  const timingKeys = [\"später\", \"verschieben\", \"kein zeit\", \"in 1-2 monaten\", \"timing\"];\n  const decisionKeys = [\"muss klären\", \"entscheider\", \"chef\", \"nicht allein entscheiden\"];\n\n  const priceHits = findMatches(priceKeys);\n  const timingHits = findMatches(timingKeys);\n  const decisionHits = findMatches(decisionKeys);\n\n  let fastlane_hit = false;\n  let fastlane_tip = null;\n  let fastlane_rule = null;\n\n  if (priceHits.length) {\n    fastlane_hit = true;\n    fastlane_rule = \"price\";\n    fastlane_tip = {\n      tip: 'Preisrahmen klären → Budget ist Kernhürde. → Sag: \"Damit ich sauber planen kann: in welchem Budgetfenster wäre das für euch heute realistisch umsetzbar?\"',\n      tip_type: \"price\",\n      confidence: 0.78,\n      reasoning_mode: \"fastlane_rule\",\n      evidence: [{ source: \"session_fact\", id: \"price_signal\", why_relevant: `Matched keywords: ${priceHits.join(\", \")}` }],\n      risk_if_wrong: \"Zu frühe Preisfrage kann bremsen.\",\n      warnings: []\n    };\n  } else if (timingHits.length) {\n    fastlane_hit = true;\n    fastlane_rule = \"timing\";\n    fastlane_tip = {\n      tip: 'Nächsten Schritt fixieren → Timing ist offen. → Sag: \"Lass uns einen festen nächsten Termin setzen: passt dir Dienstag 14 Uhr oder Donnerstag 10 Uhr besser?\"',\n      tip_type: \"timing\",\n      confidence: 0.74,\n      reasoning_mode: \"fastlane_rule\",\n      evidence: [{ source: \"session_fact\", id: \"timing_signal\", why_relevant: `Matched keywords: ${timingHits.join(\", \")}` }],\n      risk_if_wrong: \"Kann zu pushy wirken, falls noch kein Fit klar ist.\",\n      warnings: []\n    };\n  } else if (decisionHits.length) {\n    fastlane_hit = true;\n    fastlane_rule = \"decision\";\n    fastlane_tip = {\n      tip: 'Entscheider aktivieren → Entscheider fehlt im Gespräch. → Sag: \"Sollen wir den Entscheider direkt im nächsten Termin dazunehmen, damit wir es in einem Schritt final klären?\"',\n      tip_type: \"decision\",\n      confidence: 0.72,\n      reasoning_mode: \"fastlane_rule\",\n      evidence: [{ source: \"session_fact\", id: \"authority_signal\", why_relevant: `Matched keywords: ${decisionHits.join(\", \")}` }],\n      risk_if_wrong: \"Kann Druck erzeugen, wenn Beziehung noch fragil ist.\",\n      warnings: []\n    };\n  }\n\n  return [{\n    json: {\n      ...j,\n      fastlane_hit,\n      fastlane_tip,\n      fastlane_rule,\n      fastlane_debug: {\n        text_preview: baseText.slice(0, 400),\n        priceHits,\n        timingHits,\n        decisionHits\n      }\n    }\n  }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2896,
        1600
      ],
      "id": "b0687c3a-cca4-4401-8a2e-4ab8712695e7",
      "name": "Rule Fastlane v1"
    },
    {
      "parameters": {
        "jsCode": "const j = $json || {};\n  const t = j.fastlane_tip || null;\n\n  if (!t) {\n    return [{ json: { ...j, fastlane_applied: false } }];\n  }\n\n  return [{\n    json: {\n      ...j,\n      ...t,\n      fastlane_applied: true\n    }\n  }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3456,
        1584
      ],
      "id": "d3b53045-c6e8-4da6-b5a6-52a9c6b10edf",
      "name": "Apply Fastlane Tip"
    },
    {
      "parameters": {
        "jsCode": "// Fastlane-only parser\n// Erwartet Input aus \"Apply Fastlane Tip\" bzw. \"Rule Fastlane v1\"\n\nconst j = $json || {};\nconst kb = $node[\"KI-Bremse\"].json || {};\n\nfunction clamp01(v, d = 0.5) {\n  const n = Number(v);\n  return Number.isFinite(n) ? Math.max(0, Math.min(1, n)) : d;\n}\n\nfunction classifyTip(t) {\n  const s = String(t || \"\").toLowerCase();\n  if (s.includes(\"preis\") || s.includes(\"budget\") || s.includes(\"kosten\")) return \"price\";\n  if (s.includes(\"termin\") || s.includes(\"kalender\") || s.includes(\"zeit\")) return \"timing\";\n  if (s.includes(\"entscheidung\") || s.includes(\"fix\")) return \"decision\";\n  if (s.includes(\"wenn ich\") && s.includes(\"schicke\")) return \"commit\";\n  if (s.includes(\"was genau\") || s.includes(\"was hält\")) return \"objection_isolation\";\n  return \"general\";\n}\n\nlet out = {\n  tip: String(j.tip || \"\").trim() || \"Kein Tipp...\",\n  tip_type: String(j.tip_type || \"\").trim() || classifyTip(j.tip),\n  confidence: clamp01(j.confidence, 0.7),\n  reasoning_mode: \"fastlane_rule\",\n  evidence: Array.isArray(j.evidence) ? j.evidence : [],\n  risk_if_wrong: String(j.risk_if_wrong || \"\"),\n  warnings: Array.isArray(j.warnings) ? j.warnings.map(String) : [],\n  sentiment: [\"positive\", \"neutral\", \"negative\"].includes(j.sentiment) ? j.sentiment : \"neutral\",\n  talk_ratio_warning: !!j.talk_ratio_warning,\n  pacing_warning: !!j.pacing_warning\n};\n\n// Evidence fallback\nif (out.evidence.length === 0) {\n  out.evidence.push({\n    source: \"session_fact\",\n    id: String(kb.session_id || j.session_id || \"session_unknown\"),\n    why_relevant: \"Fastlane rule triggered by keyword signal.\"\n  });\n}\n\n// KI-Bremse Kontext übernehmen\nout.live_context_text = kb.live_context_text ?? j.live_context_text ?? \"\";\nout.memory_context_text = kb.memory_context_text ?? j.memory_context_text ?? \"\";\nout.memory_topics = Array.isArray(kb.memory_topics) ? kb.memory_topics : (Array.isArray(j.memory_topics) ? j.memory_topics : []);\n\nout.session_facts =\n    kb.session_facts ??\n    j.session_facts ??\n    (function () {\n      try { return $node[\"Ensure Session Facts v1\"].json.session_facts || null; } catch (_) { return null; }\n    })();\n\n\nout.reference_query = kb.reference_query ?? j.reference_query ?? \"\";\nout.ref_context = kb.ref_context ?? j.ref_context ?? \"\";\n\nout.wpm_you = kb.wpm_you ?? j.wpm_you ?? null;\nout.wpm_them = kb.wpm_them ?? j.wpm_them ?? null;\nout.wpm_burst_you = kb.wpm_burst_you ?? j.wpm_burst_you ?? null;\nout.pacing_you = kb.pacing_you ?? j.pacing_you ?? \"n/a\";\nout.pacing_them = kb.pacing_them ?? j.pacing_them ?? \"n/a\";\n\nout.talk_ratio_pct_you = kb.talk_ratio_pct_you ?? j.talk_ratio_pct_you ?? null;\nout.talk_ratio_pct_them = kb.talk_ratio_pct_them ?? j.talk_ratio_pct_them ?? null;\nout.words_you = kb.words_you ?? j.words_you ?? null;\nout.words_them = kb.words_them ?? j.words_them ?? null;\nout.dominates = kb.dominates ?? j.dominates ?? \"balanced\";\nout.avg_talk_ratio_you = kb.avg_talk_ratio_you ?? j.avg_talk_ratio_you ?? null;\n\nout.current_wpm = kb.current_wpm ?? out.wpm_you ?? null;\nout.pacing_status = kb.pacing_status ?? out.pacing_you ?? \"n/a\";\n\nconst burstWarning = kb.wpm_burst_you != null ? Number(kb.wpm_burst_you) > 170 : false;\nout.pacing_warning = !!kb.pacing_warning || out.pacing_warning || burstWarning;\n\nconst trYou = kb.talk_ratio_pct_you != null ? Number(kb.talk_ratio_pct_you) : null;\nout.talk_ratio_warning = out.talk_ratio_warning || (kb.dominates === \"you\") || (trYou !== null && trYou > 55);\n\n// Meta + tip_id\nout.generated_at = kb.generated_at || out.generated_at || new Date().toISOString();\nout.session_id = kb.session_id || out.session_id || null;\nout.lead_id = kb.lead_id || out.lead_id || null;\nout.new_run = true;\n\nfunction simpleHash(str) {\n  let h = 0;\n  const s = String(str || \"\");\n  for (let i = 0; i < s.length; i++) {\n    h = (h << 5) - h + s.charCodeAt(i);\n    h |= 0;\n  }\n  return Math.abs(h).toString(36);\n}\n\nconst tipIdBase = [\n  out.session_id || \"no_session\",\n  out.generated_at || \"\",\n  out.tip || \"\"\n].join(\"|\");\n\nout.tip_id = `tip_${simpleHash(tipIdBase)}`;\n\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3824,
        1584
      ],
      "id": "f7ca5dd5-c839-4e56-936b-f296cc11782c",
      "name": "Parse Tip JSON Fastlane"
    },
    {
      "parameters": {
        "jsCode": "const j = $json || {};\n  let sf = j.session_facts || {};\n\n  if (!sf || typeof sf !== 'object') sf = {};\n\n  sf = {\n    session_id: sf.session_id || j.session_id || null,\n    lead_id: sf.lead_id || j.lead_id || \"unknown_lead\",\n    budget_status: sf.budget_status || \"unknown\",\n    decision_maker_status: sf.decision_maker_status || \"unknown\",\n    timeline_status: sf.timeline_status || \"unknown\",\n    competitors: Array.isArray(sf.competitors) ? sf.competitors : [],\n    open_objections: Array.isArray(sf.open_objections) ? sf.open_objections : [],\n    resolved_objections: Array.isArray(sf.resolved_objections) ? sf.resolved_objections : [],\n    next_step_committed: !!sf.next_step_committed\n  };\n\n  return [{\n    json: {\n      ...j,\n      session_facts: sf,\n      session_facts_ready: true\n    }\n  }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        800
      ],
      "id": "f57a9860-5a38-4fd4-9b42-a7a28513fe35",
      "name": "Ensure Session Facts v1"
    },
    {
      "parameters": {
        "jsCode": "const now = new Date().toISOString();\n\n  function clamp01(n, fallback = 0.5) {\n    const x = Number(n);\n    if (!Number.isFinite(x)) return fallback;\n    return Math.max(0, Math.min(1, x));\n  }\n\n  const tipId =\n    $json.tip_id ||\n    `tip_fallback_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n\n  return [{\n    json: {\n      tip_id: String(tipId),\n      session_id: $json.session_id || null,\n      lead_id: $json.lead_id || null,\n      tip_type: $json.tip_type || \"general\",\n      tip_text: String($json.tip || \"\"),\n      reasoning_mode: $json.reasoning_mode || \"full_llm\",\n      confidence: clamp01($json.confidence, 0.5),\n\n      // initial defaults; werden später durch echtes Feedback überschrieben\n      applied_by_rep: false,\n      outcome_label: \"neutral\", // helpful | neutral | harmful | won\n      outcome_note: \"\",\n\n      created_at: $json.generated_at || now,\n      updated_at: now\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5328,
        416
      ],
      "id": "d918e1b0-f58c-4368-8ad7-919b946c8c9b",
      "name": "Prepare Tip Feedback Row"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "1oBkREq9Ts12BsUl",
          "mode": "list",
          "cachedResultName": "sales_intelligence_tip_feedback",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/1oBkREq9Ts12BsUl"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "tip_id",
              "keyValue": "={{ $json.tip_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "applied_by_rep": "={{ $json.applied_by_rep }}",
            "tip_id": "={{ $json.tip_id }}",
            "session_id": "={{ $json.session_id }}",
            "lead_id": "={{ $json.lead_id }}",
            "tip_type": "={{ $json.tip_type }}",
            "tip_text": "={{ $json.tip_text }}",
            "reasoning_mode": "={{ $json.reasoning_mode }}",
            "confidence": "={{ $json.confidence }}",
            "outcome_label": "={{ $json.outcome_label }}",
            "outcome_note": "={{ $json.outcome_note }}",
            "created_at": "={{ $json.created_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "tip_id",
              "displayName": "tip_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "tip_type",
              "displayName": "tip_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "tip_text",
              "displayName": "tip_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "reasoning_mode",
              "displayName": "reasoning_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "applied_by_rep",
              "displayName": "applied_by_rep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "outcome_label",
              "displayName": "outcome_label",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "outcome_note",
              "displayName": "outcome_note",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        5776,
        416
      ],
      "id": "1b6951bb-751c-4695-afc5-2c7040be1140",
      "name": "Upsert Tip Feedback"
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all().map(i => i.json || {});\n\n  const clean = rows\n    .filter(r => r && r.tip_id)\n    .slice(0, 5)\n    .map(r => ({\n      tip_id: r.tip_id,\n      tip_type: r.tip_type || \"general\",\n      outcome_label: r.outcome_label || \"neutral\",\n      applied_by_rep: !!r.applied_by_rep,\n      confidence: Number.isFinite(Number(r.confidence)) ? Number(r.confidence) : null,\n      tip_text: String(r.tip_text || \"\").slice(0, 240),\n      updated_at: r.updated_at || null\n    }));\n\n  const feedback_summary = clean.map((r, idx) =>\n    `${idx + 1}) ${r.tip_type} | outcome=${r.outcome_label} | applied=${r.applied_by_rep} | conf=${r.confidence ?? \"n/a\"} | ${r.tip_text}`\n  ).join(\"\\n\");\n\n  return [{\n    json: {\n      prior_tip_feedback: clean,\n      prior_tip_feedback_text: feedback_summary || \"No prior tip feedback for this lead.\"\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3616,
        592
      ],
      "id": "92c35883-c82b-4001-8846-1cd63426cf0c",
      "name": "Format Tip Feedback Context"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "1oBkREq9Ts12BsUl",
          "mode": "list",
          "cachedResultName": "sales_intelligence_tip_feedback",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/1oBkREq9Ts12BsUl"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "lead_id",
              "keyValue": "={{ $json.lead_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        3392,
        592
      ],
      "id": "ce22e003-b0b0-46b4-b686-d97d586555b8",
      "name": "Load Tip Feedback"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 3,
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4048,
        608
      ],
      "id": "70e7723a-21af-4e16-8d08-da529a4a951e",
      "name": "Merge2"
    },
    {
      "parameters": {
        "jsCode": "// -----------------------------\n  // Parse Tip JSON (AI path) - soft validator (no hard overwrite)\n  // -----------------------------\n\n  const raw = ($json.output || $json.text || \"\").toString().trim();\n\n  // -----------------------------\n  // Default-Fallback (IMMER gueltig)\n  // -----------------------------\n  let obj = {\n    tip: raw || \"Kein Tipp...\",\n    tip_type: \"general\",\n    confidence: 0.5,\n    reasoning_mode: \"full_llm\",\n    evidence: [],\n    risk_if_wrong: \"\",\n    warnings: [],\n    sentiment: \"neutral\",\n    talk_ratio_warning: false,\n    pacing_warning: false\n  };\n\n  // -----------------------------\n  // Helper\n  // -----------------------------\n  function readNodeJson(nodeName) {\n    try {\n      return $node[nodeName].json || {};\n    } catch (_) {\n      return {};\n    }\n  }\n\n  function tryParseJson(text) {\n    if (!text) return null;\n\n    try { return JSON.parse(text); } catch (_) {}\n\n    const start = text.indexOf(\"{\");\n    const end = text.lastIndexOf(\"}\");\n    if (start >= 0 && end > start) {\n      const slice = text.slice(start, end + 1);\n      try { return JSON.parse(slice); } catch (_) {}\n    }\n\n    return null;\n  }\n\n  function clamp01(n, fallback = 0.5) {\n    const x = Number(n);\n    if (!Number.isFinite(x)) return fallback;\n    return Math.max(0, Math.min(1, x));\n  }\n\n  function wordCount(s) {\n    return String(s || \"\").trim().split(/\\s+/).filter(Boolean).length;\n  }\n\n  function classifyTip(t) {\n    const s = String(t || \"\").toLowerCase();\n    if (s.includes(\"termin\") || s.includes(\"datum\") || s.includes(\"20.\") || s.includes(\"blocken\") || s.includes(\"kalender\")) return \"timing\";\n    if (s.includes(\"entscheidung\") || s.includes(\"fix\") || s.includes(\"heute\") || s.includes(\"gruenes licht\")) return \"decision\";\n    if (s.includes(\"wenn ich\") && s.includes(\"schicke\")) return \"commit\";\n    if (s.includes(\"was haelt\") || s.includes(\"was genau\") || s.includes(\"gibt es ausser\")) return \"objection_isolation\";\n    if (s.includes(\"preis\") || s.includes(\"budget\")) return \"price\";\n    return \"general\";\n  }\n\n  // Soft validator: mark warnings, but DO NOT overwrite tip\n  function validateTipFormat(tip) {\n    const t = String(tip || \"\").trim();\n    const re = /^(.+?)\\s*→\\s*(.+?)\\s*→\\s*Sag:\\s*\"([^\"]+)\"\\s*$/i;\n    const m = t.match(re);\n    if (!m) return { ok: false, reason: \"format_mismatch\" };\n\n    const move = m[1].trim();\n    const warum = m[2].trim();\n    const skript = m[3].trim();\n\n    const moveWords = wordCount(move);\n    const warumWords = wordCount(warum);\n    const skriptWords = wordCount(skript);\n    const totalWords = wordCount(t);\n\n    if (moveWords > 3) return { ok: false, reason: \"move_too_long\" };\n    if (warumWords > 8) return { ok: false, reason: \"warum_too_long\" };\n    if (skriptWords > 20) return { ok: false, reason: \"skript_too_long\" };\n    if (totalWords < 30 || totalWords > 45) return { ok: false, reason: \"total_words_out_of_range\" };\n\n    return { ok: true };\n  }\n\n  // -----------------------------\n  // Parse\n  // -----------------------------\n  const parsed = tryParseJson(raw);\n  if (parsed && typeof parsed === \"object\" && !Array.isArray(parsed)) {\n    obj = { ...obj, ...parsed };\n  }\n\n  const kb = readNodeJson(\"KI-Bremse\");\n  const ensureFacts = readNodeJson(\"Ensure Session Facts v1\");\n  const feedbackNode = readNodeJson(\"Build Feedback Guidance v1\");\n  const extractedLeadProfileNode = readNodeJson(\"Extract Lead Profile from Pinecone\");\n  const loadLeadProfileNode = readNodeJson(\"Load Lead Profile\");\n\n  // -----------------------------\n  // Harden live_tip_v2 fields\n  // -----------------------------\n  obj.tip = String(obj.tip || \"\").trim() || \"Kein Tipp...\";\n  obj.tip_type = String(obj.tip_type || \"\").trim() || classifyTip(obj.tip);\n  obj.confidence = clamp01(obj.confidence, 0.5);\n  obj.reasoning_mode = [\"fastlane_rule\", \"pattern_match\", \"full_llm\"].includes(obj.reasoning_mode)\n    ? obj.reasoning_mode\n    : \"full_llm\";\n\n  if (!Array.isArray(obj.evidence)) obj.evidence = [];\n  obj.evidence = obj.evidence\n    .filter((e) => e && typeof e === \"object\")\n    .map((e) => ({\n      source: [\"pattern_node\", \"historical_deal\", \"session_fact\"].includes(e.source) ? e.source : \"historical_deal\",\n      id: String(e.id || \"unknown\"),\n      why_relevant: String(e.why_relevant || \"\")\n    }));\n\n  obj.risk_if_wrong = String(obj.risk_if_wrong || \"\");\n  if (!Array.isArray(obj.warnings)) obj.warnings = [];\n  obj.warnings = obj.warnings.map((w) => String(w));\n\n  obj.sentiment = [\"positive\", \"neutral\", \"negative\"].includes(obj.sentiment) ? obj.sentiment : \"neutral\";\n  obj.talk_ratio_warning = !!obj.talk_ratio_warning;\n  obj.pacing_warning = !!obj.pacing_warning;\n\n  // -----------------------------\n  // Soft format checks (warning only)\n  // -----------------------------\n  const tipCheck = validateTipFormat(obj.tip);\n  if (!tipCheck.ok) {\n    obj.warnings.push(`tip_format_invalid:${tipCheck.reason}`);\n  }\n\n  // Hard fallback ONLY if tip is empty/useless\n  if (!obj.tip || obj.tip === \"Kein Tipp...\" || obj.tip.length < 8) {\n    obj.tip = \"Naechsten Schritt fixieren -> Kunde braucht Verbindlichkeit. -> Sag: \\\"Lass uns direkt einen klaren Termin festmachen: passt dir Mittwoch 15 Uhr oder Freitag 10 Uhr besser, damit wir verbindlich starten und keine Zeit verlieren?\\\"\";\n    obj.tip_type = \"timing\";\n    obj.confidence = Math.min(obj.confidence, 0.5);\n    obj.reasoning_mode = \"full_llm\";\n    obj.warnings.push(\"tip_empty_forced_fallback\");\n  }\n\n  // -----------------------------\n  // Carry KI-Bremse context\n  // -----------------------------\n  obj.live_context_text = kb.live_context_text ?? \"\";\n  obj.memory_context_text = kb.memory_context_text ?? \"\";\n  obj.memory_topics = Array.isArray(kb.memory_topics) ? kb.memory_topics : [];\n\n  obj.session_facts =\n    kb.session_facts ??\n    obj.session_facts ??\n    ensureFacts.session_facts ??\n    null;\n\n  obj.reference_query = kb.reference_query ?? \"\";\n  obj.ref_context = kb.ref_context ?? \"\";\n\n  obj.wpm_you = kb.wpm_you ?? null;\n  obj.wpm_them = kb.wpm_them ?? null;\n  obj.wpm_burst_you = kb.wpm_burst_you ?? null;\n\n  obj.pacing_you = kb.pacing_you ?? \"n/a\";\n  obj.pacing_them = kb.pacing_them ?? \"n/a\";\n\n  obj.talk_ratio_pct_you = kb.talk_ratio_pct_you ?? null;\n  obj.talk_ratio_pct_them = kb.talk_ratio_pct_them ?? null;\n\n  obj.words_you = kb.words_you ?? null;\n  obj.words_them = kb.words_them ?? null;\n\n  obj.dominates = kb.dominates ?? \"balanced\";\n  obj.avg_talk_ratio_you = kb.avg_talk_ratio_you ?? null;\n\n  obj.current_wpm = kb.current_wpm ?? obj.wpm_you ?? null;\n  obj.pacing_status = kb.pacing_status ?? obj.pacing_you ?? \"n/a\";\n\n  // -----------------------------\n  // Deterministic warnings\n  // -----------------------------\n  const burstWarning = kb.wpm_burst_you != null ? Number(kb.wpm_burst_you) > 170 : false;\n  obj.pacing_warning = !!kb.pacing_warning || burstWarning;\n\n  const trYou = kb.talk_ratio_pct_you != null ? Number(kb.talk_ratio_pct_you) : null;\n  obj.talk_ratio_warning = kb.dominates === \"you\" || (trYou !== null && trYou > 55);\n\n  // Allowed tip types\n  const allowedTipTypes = [\"timing\", \"decision\", \"commit\", \"objection_isolation\", \"price\", \"general\"];\n  if (!allowedTipTypes.includes(obj.tip_type)) {\n    obj.tip_type = classifyTip(obj.tip);\n  }\n\n  // Evidence fallback\n  if (obj.evidence.length === 0) {\n    obj.evidence.push({\n      source: \"session_fact\",\n      id: String(kb.session_id || \"session_unknown\"),\n      why_relevant: \"Fallback evidence from current session context.\"\n    });\n  }\n\n  // -----------------------------\n  // Feedback fields (from guidance node)\n  // -----------------------------\n  obj.feedback_best_tip_type = feedbackNode.feedback_best_tip_type ?? obj.feedback_best_tip_type ?? null;\n  obj.feedback_avoid_tip_type = feedbackNode.feedback_avoid_tip_type ?? obj.feedback_avoid_tip_type ?? null;\n  obj.feedback_guidance = feedbackNode.feedback_guidance ?? obj.feedback_guidance ?? \"\";\n  obj.feedback_scored_types = Array.isArray(feedbackNode.feedback_scored_types)\n    ? feedbackNode.feedback_scored_types\n    : (Array.isArray(obj.feedback_scored_types) ? obj.feedback_scored_types : []);\n  obj.feedback_rows_used = Number.isFinite(Number(feedbackNode.feedback_rows_used))\n    ? Number(feedbackNode.feedback_rows_used)\n    : (Number.isFinite(Number(obj.feedback_rows_used)) ? Number(obj.feedback_rows_used) : 0);\n\n  // -----------------------------\n  // Lead profile fields (from Pinecone)\n  // -----------------------------\n  let leadProfile = null;\n  let leadProfileDebug = null;\n\n  // Preferred source: Extract Lead Profile from Pinecone\n  if (extractedLeadProfileNode && typeof extractedLeadProfileNode === \"object\") {\n    if (extractedLeadProfileNode.lead_profile && typeof extractedLeadProfileNode.lead_profile === \"object\") {\n      leadProfile = extractedLeadProfileNode.lead_profile;\n    }\n    if (extractedLeadProfileNode.lead_profile_debug && typeof extractedLeadProfileNode.lead_profile_debug === \"object\") {\n      leadProfileDebug = extractedLeadProfileNode.lead_profile_debug;\n    }\n  }\n\n  // Fallback source: directly from Load Lead Profile matches\n  if (!leadProfile) {\n    const matches = Array.isArray(loadLeadProfileNode.matches) ? loadLeadProfileNode.matches : [];\n    if (matches.length) {\n      const sorted = [...matches].sort((a, b) => {\n        const ta = Date.parse(a?.metadata?.processed_at || a?.metadata?.timestamp || 0) || 0;\n        const tb = Date.parse(b?.metadata?.processed_at || b?.metadata?.timestamp || 0) || 0;\n        return tb - ta;\n      });\n      const picked = sorted[0];\n      const m = picked?.metadata || {};\n      leadProfile = {\n        lead_name: m.lead_name ?? null,\n        contact_name: m.contact_name ?? null,\n        company_name: m.company_name ?? null,\n        city_tag: m.city_tag ?? null,\n        industry: m.industry ?? null,\n        lead_source: m.lead_source ?? null,\n        lead_owner_name: m.lead_owner_name ?? null,\n        deal_stage_at_call: m.deal_stage_at_call ?? null,\n        avg_response_days: m.avg_response_days ?? null,\n        email_count: m.email_count ?? null,\n        notes_count: m.notes_count ?? null\n      };\n      leadProfileDebug = {\n        matches_count: matches.length,\n        picked_from_id: picked?.id || null\n      };\n    }\n  }\n\n  if (!leadProfile) {\n    leadProfile = {\n      lead_name: null,\n      contact_name: null,\n      company_name: null,\n      city_tag: null,\n      industry: null,\n      lead_source: null,\n      lead_owner_name: null,\n      deal_stage_at_call: null,\n      avg_response_days: null,\n      email_count: null,\n      notes_count: null\n    };\n  }\n\n  if (!leadProfileDebug) {\n    leadProfileDebug = {\n      matches_count: 0,\n      picked_from_id: null\n    };\n  }\n\n  obj.lead_profile = leadProfile;\n  obj.lead_profile_debug = leadProfileDebug;\n\n  // Flat convenience fields for overlay/UI\n  obj.lead_name = leadProfile.lead_name ?? null;\n  obj.contact_name = leadProfile.contact_name ?? null;\n  obj.company_name = leadProfile.company_name ?? null;\n  obj.city_tag = leadProfile.city_tag ?? null;\n  obj.industry = leadProfile.industry ?? null;\n  obj.lead_source = leadProfile.lead_source ?? null;\n  obj.lead_owner_name = leadProfile.lead_owner_name ?? null;\n  obj.deal_stage_at_call = leadProfile.deal_stage_at_call ?? null;\n  obj.avg_response_days = leadProfile.avg_response_days ?? null;\n  obj.email_count = leadProfile.email_count ?? null;\n  obj.notes_count = leadProfile.notes_count ?? null;\n\n  // -----------------------------\n  // Meta + tip_id\n  // -----------------------------\n  obj.generated_at = kb.generated_at || obj.generated_at || new Date().toISOString();\n  obj.session_id = kb.session_id || obj.session_id || ensureFacts.session_id || null;\n  obj.lead_id = kb.lead_id || obj.lead_id || ensureFacts.lead_id || null;\n  obj.new_run = true;\n\n  function simpleHash(str) {\n    let h = 0;\n    const s = String(str || \"\");\n    for (let i = 0; i < s.length; i++) {\n      h = (h << 5) - h + s.charCodeAt(i);\n      h |= 0;\n    }\n    return Math.abs(h).toString(36);\n  }\n\n  const tipIdBase = [\n    obj.session_id || \"no_session\",\n    obj.generated_at || \"\",\n    obj.tip || \"\"\n  ].join(\"|\");\n\n  obj.tip_id = obj.tip_id || `tip_${simpleHash(tipIdBase)}`;\n\n  // warning cleanup (unique)\n  obj.warnings = [...new Set(obj.warnings)];\n\n  return [{ json: obj }]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4672,
        608
      ],
      "id": "3fff4fbc-fc88-4339-baf9-82b8ae0a1b97",
      "name": "Parse Tip JSON (AI path)"
    },
    {
      "parameters": {
        "jsCode": "const src = (\n    ($json && typeof $json === \"object\" && $json.body && typeof $json.body === \"object\" && !Array.isArray($json.body))\n      ? $json.body\n      : (($json && typeof $json === \"object\" && $json.query && typeof $json.query === \"object\")\n        ? $json.query\n        : ($json || {}))\n  );\n\n  const allowed = [\"helpful\", \"neutral\", \"harmful\", \"won\"];\n\n  const tip_id = String(src.tip_id ?? \"\").trim();\n  const outcome_label = String(src.outcome_label ?? \"\").trim().toLowerCase();\n  const outcome_note = String(src.outcome_note ?? \"\").trim();\n  const applied_by_rep = (typeof src.applied_by_rep === \"boolean\")\n    ? src.applied_by_rep\n    : (String(src.applied_by_rep ?? \"\").toLowerCase() === \"true\");\n\n  if (!tip_id) throw new Error(\"tip_id is required\");\n  if (!allowed.includes(outcome_label)) {\n    throw new Error(\"outcome_label must be one of: helpful|neutral|harmful|won\");\n  }\n\n  return [{\n    json: {\n      tip_id,\n      outcome_label,\n      outcome_note,\n      applied_by_rep,\n      updated_at: new Date().toISOString()\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        1472
      ],
      "id": "40b727d4-4162-4f40-bd14-924d67c0d5e2",
      "name": "Validate Outcome Payload"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "1oBkREq9Ts12BsUl",
          "mode": "list",
          "cachedResultName": "sales_intelligence_tip_feedback",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/1oBkREq9Ts12BsUl"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "tip_id",
              "keyValue": "={{ $json.tip_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "applied_by_rep": "={{ $json.applied_by_rep }}",
            "outcome_label": "={{ $json.outcome_label }}",
            "outcome_note": "={{ $json.outcome_note }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "tip_id",
              "displayName": "tip_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tip_type",
              "displayName": "tip_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tip_text",
              "displayName": "tip_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reasoning_mode",
              "displayName": "reasoning_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "confidence",
              "displayName": "confidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "applied_by_rep",
              "displayName": "applied_by_rep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "outcome_label",
              "displayName": "outcome_label",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "outcome_note",
              "displayName": "outcome_note",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1792,
        1456
      ],
      "id": "66c25282-d7ef-4fe9-9d23-df8084839c19",
      "name": "Update Tip Feedback"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "1oBkREq9Ts12BsUl",
          "mode": "list",
          "cachedResultName": "sales_intelligence_tip_feedback",
          "cachedResultUrl": "/projects/iVpc6QeIonfXUGaZ/datatables/1oBkREq9Ts12BsUl"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "tip_id",
              "keyValue": "={{ $json.tip_id }}"
            }
          ]
        },
        "limit": 10
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        1024,
        1360
      ],
      "id": "691e1393-c4e6-4dce-a0e7-67d037f55eeb",
      "name": "Get Tip Feedback Row"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1424,
        1456
      ],
      "id": "75846b6c-7657-481f-845c-040034708e15",
      "name": "Merge Payload + Row"
    },
    {
      "parameters": {
        "jsCode": "const j = $json || {};\n\n  if (!j.id) {\n    throw new Error(\"No existing tip_feedback row found for tip_id\");\n  }\n\n  return [{\n    json: {\n      id: j.id,\n      tip_id: j.tip_id,\n      outcome_label: j.outcome_label,\n      outcome_note: j.outcome_note || \"\",\n      applied_by_rep: !!j.applied_by_rep,\n      updated_at: j.updated_at || new Date().toISOString()\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        1456
      ],
      "id": "1d067893-eced-48d6-8934-52f53e05260e",
      "name": "Guard Existing Row"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n    ok: true,\n    tip_id: $json.tip_id,\n    outcome_label: $json.outcome_label,\n    updated_at: $json.updated_at\n  }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        2016,
        1456
      ],
      "id": "3335cb2d-acbd-41f1-b65a-c30767c295c2",
      "name": "Respond Success"
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all().map(i => i.json || {});\n  if (!rows.length) {\n    throw new Error(\"No existing tip_feedback row found for tip_id\");\n  }\n\n  const p = $node[\"Validate Outcome Payload\"].json || {};\n\n  function score(r) {\n    let s = 0;\n    if (r.session_id) s++;\n    if (r.lead_id) s++;\n    if (r.tip_type) s++;\n    if (r.tip_text) s++;\n    if (r.reasoning_mode) s++;\n    if (r.confidence !== null && r.confidence !== undefined) s++;\n    if (r.created_at) s++;\n    return s;\n  }\n\n  rows.sort((a, b) => score(b) - score(a));\n\n  const best = rows[0];\n\n  return [{\n    json: {\n      id: best.id,\n      tip_id: best.tip_id,\n      outcome_label: p.outcome_label,\n      outcome_note: p.outcome_note || \"\",\n      applied_by_rep: !!p.applied_by_rep,\n      updated_at: p.updated_at || new Date().toISOString()\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        1360
      ],
      "id": "83ce3207-dbb3-4321-9f16-2c9627a8f713",
      "name": "Select Canonical Tip Row"
    },
    {
      "parameters": {
        "jsCode": "// Build Feedback Guidance v1 (robust)\n  // Primary source: \"Load Tip Feedback\" node output\n  // Fallback source: $json.prior_tip_feedback\n\n  let items = [];\n  try {\n    items = ($items(\"Load Tip Feedback\") || []).map(i => i.json || {});\n  } catch (_) {\n    items = [];\n  }\n\n  if (!items.length) {\n    items = Array.isArray($json.prior_tip_feedback) ? $json.prior_tip_feedback : [];\n  }\n\n  // Keep only usable rows\n  items = items.filter(r => r && (r.tip_type || r.outcome_label));\n\n  const byType = {};\n  for (const r of items) {\n    const t = String(r.tip_type || \"general\");\n    if (!byType[t]) byType[t] = { helpful: 0, harmful: 0, won: 0, neutral: 0, total: 0 };\n\n    const o = String(r.outcome_label || \"neutral\").toLowerCase();\n    if (o === \"helpful\") byType[t].helpful++;\n    else if (o === \"harmful\") byType[t].harmful++;\n    else if (o === \"won\") byType[t].won++;\n    else byType[t].neutral++;\n\n    byType[t].total++;\n  }\n\n  const scored = Object.entries(byType)\n    .map(([tip_type, s]) => {\n      const score = (s.helpful * 1) + (s.won * 3) - (s.harmful * 2);\n      return { tip_type, score, ...s };\n    })\n    .sort((a, b) => b.score - a.score);\n\n  const bestRaw = scored[0] || null;\n  const worstRaw = scored.length ? [...scored].sort((a, b) => a.score - b.score)[0] : null;\n\n  // Guardrails: avoid overfitting to very small sample sizes\n  const bestEligible = !!(\n    bestRaw &&\n    bestRaw.total >= 2 &&\n    bestRaw.score > 0\n  );\n\n  const avoidEligible = !!(\n    worstRaw &&\n    (\n      worstRaw.harmful >= 2 ||\n      worstRaw.score <= -2\n    )\n  );\n\n  const best = bestEligible ? bestRaw : null;\n  const avoid = avoidEligible ? worstRaw : null;\n\n  let feedback_guidance = \"Keine verwertbare Feedback-Historie vorhanden.\";\n\n  if (scored.length > 0) {\n    feedback_guidance = \"Feedback vorhanden, aber noch zu wenig für harte Steuerung.\";\n  }\n\n  if (best) {\n    feedback_guidance =\n      `Bevorzuge ${best.tip_type} (score=${best.score}, total=${best.total}, helpful=${best.helpful}, won=${best.won}).`;\n  }\n\n  if (avoid && (!best || avoid.tip_type !== best.tip_type)) {\n    feedback_guidance +=\n      ` Vermeide ${avoid.tip_type} (score=${avoid.score}, total=${avoid.total}, harmful=${avoid.harmful}).`;\n  }\n\n  // Optional diagnostics for prompt/debug\n  const feedback_min_samples_for_best = 2;\n  const feedback_min_harmful_for_avoid = 2;\n  const feedback_min_negative_score_for_avoid = -2;\n\n  return [{\n    json: {\n      feedback_scored_types: scored.slice(0, 6),\n      feedback_best_tip_type: best ? best.tip_type : null,\n      feedback_avoid_tip_type: avoid ? avoid.tip_type : null,\n      feedback_guidance,\n      feedback_rules: {\n        min_samples_for_best: feedback_min_samples_for_best,\n        min_harmful_for_avoid: feedback_min_harmful_for_avoid,\n        min_negative_score_for_avoid: feedback_min_negative_score_for_avoid\n      },\n      feedback_source: items.length ? \"load_tip_feedback\" : \"prior_tip_feedback\",\n      feedback_rows_used: items.length\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3824,
        592
      ],
      "id": "bf92c30a-5c20-4572-937f-6ac1bdb9d44e",
      "name": "Build Feedback Guidance v1"
    },
    {
      "parameters": {
        "jsCode": "const leadId =\n    $json.lead_id ||\n    \"lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN\";\n\n  const sessionId = $json.session_id || \"call-feedback-sim-001\";\n  const now = Date.now();\n\n  function iso(offsetMs = 0) {\n    return new Date(now + offsetMs).toISOString();\n  }\n\n  const rows = [\n    {\n      tip_id: `tip_sim_price_harmful_${now}_1`,\n      session_id: sessionId,\n      lead_id: leadId,\n      tip_type: \"price\",\n      tip_text: \"Budget erfragen -> zu frueh im Call.\",\n      reasoning_mode: \"full_llm\",\n      confidence: 0.65,\n      applied_by_rep: true,\n      outcome_label: \"harmful\",\n      outcome_note: \"Preisfrage kam zu frueh.\",\n      created_at: iso(-60000),\n      updated_at: iso(-60000),\n    },\n    {\n      tip_id: `tip_sim_price_harmful_${now}_2`,\n      session_id: sessionId,\n      lead_id: leadId,\n      tip_type: \"price\",\n      tip_text: \"Budget klaeren -> Kunde blockt.\",\n      reasoning_mode: \"full_llm\",\n      confidence: 0.66,\n      applied_by_rep: true,\n      outcome_label: \"harmful\",\n      outcome_note: \"Kunde ist ausgestiegen.\",\n      created_at: iso(-50000),\n      updated_at: iso(-50000),\n    },\n    {\n      tip_id: `tip_sim_timing_helpful_${now}_1`,\n      session_id: sessionId,\n      lead_id: leadId,\n      tip_type: \"timing\",\n      tip_text: \"Termin fixieren -> naechster Schritt verbindlich.\",\n      reasoning_mode: \"full_llm\",\n      confidence: 0.72,\n      applied_by_rep: true,\n      outcome_label: \"helpful\",\n      outcome_note: \"Termin direkt vereinbart.\",\n      created_at: iso(-40000),\n      updated_at: iso(-40000),\n    },\n    {\n      tip_id: `tip_sim_decision_helpful_${now}_1`,\n      session_id: sessionId,\n      lead_id: leadId,\n      tip_type: \"decision\",\n      tip_text: \"Entscheidung einfordern -> Klarheit geschaffen.\",\n      reasoning_mode: \"full_llm\",\n      confidence: 0.74,\n      applied_by_rep: true,\n      outcome_label: \"helpful\",\n      outcome_note: \"Naechster Schritt klar definiert.\",\n      created_at: iso(-30000),\n      updated_at: iso(-30000),\n    },\n  ];\n\n  return rows.map((r) => ({ json: r }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5568,
        416
      ],
      "id": "16a0e6bc-1f9a-4494-838a-955078ab6684",
      "name": "Generate Feedback Test Rows"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sales-intelligence-1536-6d997vo.svc.aped-4627-b74a.pinecone.io/query",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "pineconeApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    namespace: \"sales_intelligence_v2\",\n    topK: 50,\n    includeMetadata: true,\n    includeValues: false,\n    vector: Array(1536).fill(0),\n    filter: {\n      lead_id: {\n        \"$eq\": String($node[\"Ensure Session Facts v1\"].json.lead_id || \"\").trim()\n      }\n    }\n  }\n  }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3488,
        1088
      ],
      "id": "b6164f64-020d-4d52-9a87-3b5a48bdb15b",
      "name": "Load Lead Profile",
      "credentials": {
        "pineconeApi": {
          "id": "WtQEcZxJDwVhbXQi",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const matches = Array.isArray($json.matches) ? $json.matches : [];\n\n  if (!matches.length) {\n    return [{\n      json: {\n        lead_profile: {\n          lead_name: null,\n          contact_name: null,\n          company_name: null,\n          city_tag: null,\n          industry: null,\n          lead_source: null,\n          lead_owner_name: null,\n          deal_stage_at_call: null,\n          avg_response_days: null,\n          email_count: null,\n          notes_count: null\n        },\n        lead_profile_debug: {\n          matches_count: 0,\n          picked_from_id: null\n        }\n      }\n    }];\n  }\n\n  // Nimm den neuesten Datensatz (processed_at/timestamp)\n  const sorted = [...matches].sort((a, b) => {\n    const ta = Date.parse(a?.metadata?.processed_at || a?.metadata?.timestamp || 0) || 0;\n    const tb = Date.parse(b?.metadata?.processed_at || b?.metadata?.timestamp || 0) || 0;\n    return tb - ta;\n  });\n\n  const best = sorted[0];\n  const m = best?.metadata || {};\n\n  return [{\n    json: {\n      lead_profile: {\n        lead_name: m.lead_name ?? null,\n        contact_name: m.contact_name ?? null,\n        company_name: m.company_name ?? null,\n        city_tag: m.city_tag ?? null,\n        industry: m.industry ?? null,\n        lead_source: m.lead_source ?? null,\n        lead_owner_name: m.lead_owner_name ?? null,\n        deal_stage_at_call: m.deal_stage_at_call ?? null,\n        avg_response_days: m.avg_response_days ?? null,\n        email_count: m.email_count ?? null,\n        notes_count: m.notes_count ?? null\n      },\n      lead_profile_debug: {\n        matches_count: matches.length,\n        picked_from_id: best?.id || null\n      }\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3792,
        1088
      ],
      "id": "1f43d1e7-d373-4946-8b78-63bd423db073",
      "name": "Extract Lead Profile from Pinecone"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tip-outcome",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        528,
        1472
      ],
      "id": "72fbb9d6-d0f1-440f-9dad-8e48b2ebcc86",
      "name": "Webhook Tip Feedback",
      "webhookId": "6fa56c5c-5a96-4a0a-9ec5-7ef4dd867610"
    }
  ],
  "pinData": {
    "Webhook1": [
      {
        "json": {
          "headers": {
            "host": "viralhouse.app.n8n.cloud",
            "user-agent": "node-fetch",
            "content-length": "569987",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2003:ff:ef10:2b00:64cb:cf2a:e8c0:3f11",
            "cf-ew-via": "15",
            "cf-ipcountry": "DE",
            "cf-ray": "9c716c89e1753837-FRA",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "multipart/form-data;boundary=--------------------------bc3834a30ddbf606a1b6c34c",
            "x-forwarded-for": "2003:ff:ef10:2b00:64cb:cf2a:e8c0:3f11, 162.158.94.118",
            "x-forwarded-host": "viralhouse.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-84-57fcbd49bc-vc9qc",
            "x-is-trusted": "yes",
            "x-real-ip": "2003:ff:ef10:2b00:64cb:cf2a:e8c0:3f11"
          },
          "params": {},
          "query": {},
          "body": {
            "session_id": "call-1769944106",
            "speaker": "you",
            "source": "mic"
          },
          "webhookUrl": "https://viralhouse.app.n8n.cloud/webhook/live-stt",
          "executionMode": "production"
        },
        "binary": {
          "audio": {
            "mimeType": "audio/wav",
            "fileType": "audio",
            "fileExtension": "wav",
            "data": "filesystem-v2",
            "fileName": "temp_mic_1769948627539.wav",
            "id": "filesystem-v2:workflows/JMHSa01VkTbbPgWg/executions/temp/binary_data/3256f1cf-0588-46ca-bf83-3f010a439ddf",
            "fileSize": "569 kB"
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Webhook GET Endpoint für Overlay": [
      {
        "json": {
          "headers": {
            "host": "viralhouse.app.n8n.cloud",
            "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2003:e3:df35:db00:2010:4353:4a04:6990",
            "cf-ew-via": "15",
            "cf-ipcountry": "DE",
            "cf-ray": "9d0ee4f0c0ea3ee4-AMS",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "origin": "null",
            "priority": "u=1, i",
            "sec-ch-ua": "\"Not(A:Brand\";v=\"8\", \"Chromium\";v=\"144\", \"Google Chrome\";v=\"144\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"macOS\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "2003:e3:df35:db00:2010:4353:4a04:6990, 104.23.166.157",
            "x-forwarded-host": "viralhouse.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-84-57fcbd49bc-vc9qc",
            "x-is-trusted": "yes",
            "x-real-ip": "2003:e3:df35:db00:2010:4353:4a04:6990"
          },
          "params": {},
          "query": {
            "action": "get_tip",
            "session_id": "call-1770112476",
            "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN"
          },
          "body": {},
          "webhookUrl": "https://viralhouse.app.n8n.cloud/webhook/get-tips/overlay",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Load Tip Feedback": [
      {
        "json": {
          "tip_id": "tip_gtm48x",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Nächsten Schritt fixieren → Kunde braucht Verbindlichkeit. → Sag: \"Lass uns direkt einen klaren Termin festmachen: passt dir Mittwoch 15 Uhr oder Freitag 10 Uhr besser, damit wir verbindlich starten und keine Zeit verlieren?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.5,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T09:42:37.253Z",
          "updated_at": "2026-02-20T09:53:59.308Z",
          "id": 2,
          "createdAt": "2026-02-20T09:57:42.117Z",
          "updatedAt": "2026-02-20T09:57:42.117Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_5yv4n6",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Nächsten Schritt fixieren → Kunde braucht Verbindlichkeit. → Sag: \"Lass uns direkt einen klaren Termin festmachen: passt dir Mittwoch 15 Uhr oder Freitag 10 Uhr besser, damit wir verbindlich starten und keine Zeit verlieren?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.5,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T10:10:02.925Z",
          "updated_at": "2026-02-20T10:10:10.130Z",
          "id": 3,
          "createdAt": "2026-02-20T10:10:10.149Z",
          "updatedAt": "2026-02-20T10:10:10.149Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_9toakl",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Preisrahmen klären → Budget ist Kernhürde. → Sag: \"Damit ich sauber planen kann: in welchem Budgetfenster wäre das für euch heute realistisch umsetzbar?\"",
          "reasoning_mode": "fastlane_rule",
          "confidence": 0.78,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:12:48.213Z",
          "updated_at": "2026-02-20T11:12:48.440Z",
          "id": 4,
          "createdAt": "2026-02-20T11:12:48.458Z",
          "updatedAt": "2026-02-20T11:12:48.458Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_c7m6kr",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klären → Budget ist unklar. → Sag: \"Um starten zu können, welches Budget habt ihr für Marketing eingeplant?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Hat zu klarem naechsten Schritt gefuehrt",
          "created_at": "2026-02-20T11:13:07.249Z",
          "updated_at": "2026-02-20T11:28:46.054Z",
          "id": 5,
          "createdAt": "2026-02-20T11:13:16.402Z",
          "updatedAt": "2026-02-20T11:28:46.123Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_1gr960",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen → Budget ist noch unklar. → Sag: \"Was habt ihr für Marketing-Maßnahmen budgetiert, um die Planung zu starten?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.78,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:22:16.878Z",
          "updated_at": "2026-02-20T11:22:21.918Z",
          "id": 6,
          "createdAt": "2026-02-20T11:22:21.932Z",
          "updatedAt": "2026-02-20T11:22:21.932Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sh016x",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin vereinbaren → Dringlichkeit benötigt klare Festlegung. → Sag: \"Wann passt es dir am besten, um die nächsten Schritte zu besprechen, vielleicht Mittwoch 15 Uhr oder Freitag 10 Uhr?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:27:32.307Z",
          "updated_at": "2026-02-20T11:27:38.489Z",
          "id": 7,
          "createdAt": "2026-02-20T11:27:38.505Z",
          "updatedAt": "2026-02-20T11:27:38.505Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_myetyx",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen → Klärung ist entscheidend. → Sag: \"Was habt ihr als Budget für unsere Marketingmaßnahmen eingeplant, um besser planen zu können?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.78,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:28:51.756Z",
          "updated_at": "2026-02-20T11:28:59.619Z",
          "id": 8,
          "createdAt": "2026-02-20T11:28:59.632Z",
          "updatedAt": "2026-02-20T11:28:59.632Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_ihxu24",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget ansprechen → Klärung dringend erforderlich. → Sag: \"Welches Budget plant ihr für eure Marketingaktivitäten, um konkret weiterzuarbeiten?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.78,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:41:05.427Z",
          "updated_at": "2026-02-20T11:41:09.723Z",
          "id": 9,
          "createdAt": "2026-02-20T11:41:09.738Z",
          "updatedAt": "2026-02-20T11:41:09.738Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_l0hvgp",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen → Klarheit ist entscheidend. → Sag: \"Welches Budget habt ihr für Marketing eingeplant, um die nächsten Schritte zu planen?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.78,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:42:53.358Z",
          "updated_at": "2026-02-20T11:43:01.427Z",
          "id": 10,
          "createdAt": "2026-02-20T11:43:01.442Z",
          "updatedAt": "2026-02-20T11:43:01.442Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_zeem3f",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin vereinbaren → Dringlichkeit benötigt klare Festlegung. → Sag: \"Wann wäre es für euch passend, um einen Termin zu finden und die Details zu besprechen?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T11:48:50.425Z",
          "updated_at": "2026-02-20T11:48:57.025Z",
          "id": 11,
          "createdAt": "2026-02-20T11:48:57.040Z",
          "updatedAt": "2026-02-20T11:48:57.040Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_47qrbh",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Details klären → Dringlichkeit zur Planung ist notwendig. → Sag: \"Wann können wir uns treffen, um die Marketingmaßnahmen im Detail zu besprechen?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preis zu frueh",
          "created_at": "2026-02-20T11:49:18.843Z",
          "updated_at": "2026-02-20T13:23:42.480Z",
          "id": 12,
          "createdAt": "2026-02-20T11:49:22.716Z",
          "updatedAt": "2026-02-20T13:23:42.567Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_e8so8c",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Nächste Schritte klären → Verbindlichkeit ist wichtig. → Sag: \"Wie sieht euer Zeitrahmen aus, um die nächsten Schritte gemeinsam zu planen?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preis hat gebremst",
          "created_at": "2026-02-20T11:49:18.858Z",
          "updated_at": "2026-02-20T13:23:56.214Z",
          "id": 13,
          "createdAt": "2026-02-20T11:49:23.124Z",
          "updatedAt": "2026-02-20T13:23:56.275Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_zluol",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budgetrahmen klären → Verbindlichkeit für Planung notwendig. → Sag: \"Könnt ihr mir sagen, welches Budget ihr für Marketing eingeplant habt?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin fixiert",
          "created_at": "2026-02-20T11:53:02.666Z",
          "updated_at": "2026-02-20T13:24:18.737Z",
          "id": 14,
          "createdAt": "2026-02-20T11:53:06.227Z",
          "updatedAt": "2026-02-20T13:24:18.804Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_tizq3s",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klären → Dringlichkeit für Planung erfragen. → Sag: \"Kannst du mir sagen, welches Budget ihr für Marketing festgelegt habt, damit wir die nächsten Schritte planen können?\"",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar",
          "created_at": "2026-02-20T11:53:02.611Z",
          "updated_at": "2026-02-20T13:24:26.863Z",
          "id": 15,
          "createdAt": "2026-02-20T11:53:08.684Z",
          "updatedAt": "2026-02-20T13:24:26.920Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_wt4woq",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget bestätigen → Klärung der finanziellen Rahmenbedingungen. → Sag: \"Um den nächsten Schritt zu planen, welches Budget steht für Marketing zur Verfügung?\"",
          "reasoning_mode": "pattern_match",
          "confidence": 0.75,
          "applied_by_rep": false,
          "outcome_label": "neutral",
          "outcome_note": "",
          "created_at": "2026-02-20T13:28:45.429Z",
          "updated_at": "2026-02-20T13:28:56.583Z",
          "id": 16,
          "createdAt": "2026-02-20T13:28:56.596Z",
          "updatedAt": "2026-02-20T13:28:56.596Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_urg4oz",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klären → Wichtig für Planung zukünftiger Schritte. → Sag: \"Was habt ihr an Marketing-Budget eingeplant, um zu starten?\"",
          "reasoning_mode": "pattern_match",
          "confidence": 0.7,
          "applied_by_rep": true,
          "outcome_label": "won",
          "outcome_note": "Deal gewonnen",
          "created_at": "2026-02-20T13:29:29.119Z",
          "updated_at": "2026-02-20T14:50:00.970Z",
          "id": 17,
          "createdAt": "2026-02-20T13:29:33.312Z",
          "updatedAt": "2026-02-20T14:50:01.047Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594410426_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:32:30.426Z",
          "updated_at": "2026-02-20T13:32:30.426Z",
          "id": 18,
          "createdAt": "2026-02-20T13:33:54.529Z",
          "updatedAt": "2026-02-20T13:33:54.529Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594410426_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:32:40.426Z",
          "updated_at": "2026-02-20T13:32:40.426Z",
          "id": 19,
          "createdAt": "2026-02-20T13:33:54.600Z",
          "updatedAt": "2026-02-20T13:33:54.600Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771594410426_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:32:50.426Z",
          "updated_at": "2026-02-20T13:32:50.426Z",
          "id": 20,
          "createdAt": "2026-02-20T13:33:54.669Z",
          "updatedAt": "2026-02-20T13:33:54.669Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771594410426_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:33:00.426Z",
          "updated_at": "2026-02-20T13:33:00.426Z",
          "id": 21,
          "createdAt": "2026-02-20T13:33:54.730Z",
          "updatedAt": "2026-02-20T13:33:54.730Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594509649_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:34:09.649Z",
          "updated_at": "2026-02-20T13:34:09.649Z",
          "id": 22,
          "createdAt": "2026-02-20T13:35:09.662Z",
          "updatedAt": "2026-02-20T13:35:09.662Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594509649_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:34:19.649Z",
          "updated_at": "2026-02-20T13:34:19.649Z",
          "id": 23,
          "createdAt": "2026-02-20T13:35:09.733Z",
          "updatedAt": "2026-02-20T13:35:09.733Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771594509649_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:34:29.649Z",
          "updated_at": "2026-02-20T13:34:29.649Z",
          "id": 24,
          "createdAt": "2026-02-20T13:35:09.793Z",
          "updatedAt": "2026-02-20T13:35:09.793Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771594509649_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:34:39.649Z",
          "updated_at": "2026-02-20T13:34:39.649Z",
          "id": 25,
          "createdAt": "2026-02-20T13:35:09.885Z",
          "updatedAt": "2026-02-20T13:35:09.885Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594576860_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:35:16.860Z",
          "updated_at": "2026-02-20T13:35:16.860Z",
          "id": 26,
          "createdAt": "2026-02-20T13:36:16.875Z",
          "updatedAt": "2026-02-20T13:36:16.875Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771594576860_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:35:26.860Z",
          "updated_at": "2026-02-20T13:35:26.860Z",
          "id": 27,
          "createdAt": "2026-02-20T13:36:16.932Z",
          "updatedAt": "2026-02-20T13:36:16.932Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771594576860_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:35:36.860Z",
          "updated_at": "2026-02-20T13:35:36.860Z",
          "id": 28,
          "createdAt": "2026-02-20T13:36:17.000Z",
          "updatedAt": "2026-02-20T13:36:17.000Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771594576860_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:35:46.860Z",
          "updated_at": "2026-02-20T13:35:46.860Z",
          "id": 29,
          "createdAt": "2026-02-20T13:36:17.069Z",
          "updatedAt": "2026-02-20T13:36:17.069Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595387923_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:48:47.923Z",
          "updated_at": "2026-02-20T13:48:47.923Z",
          "id": 30,
          "createdAt": "2026-02-20T13:49:47.939Z",
          "updatedAt": "2026-02-20T13:49:47.939Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595387923_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:48:57.923Z",
          "updated_at": "2026-02-20T13:48:57.923Z",
          "id": 31,
          "createdAt": "2026-02-20T13:49:48.030Z",
          "updatedAt": "2026-02-20T13:49:48.030Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771595387923_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:49:07.923Z",
          "updated_at": "2026-02-20T13:49:07.923Z",
          "id": 32,
          "createdAt": "2026-02-20T13:49:48.088Z",
          "updatedAt": "2026-02-20T13:49:48.088Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771595387923_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:49:17.923Z",
          "updated_at": "2026-02-20T13:49:17.923Z",
          "id": 33,
          "createdAt": "2026-02-20T13:49:48.171Z",
          "updatedAt": "2026-02-20T13:49:48.171Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595469936_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:50:09.936Z",
          "updated_at": "2026-02-20T13:50:09.936Z",
          "id": 34,
          "createdAt": "2026-02-20T13:51:09.954Z",
          "updatedAt": "2026-02-20T13:51:09.954Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595469936_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:50:19.936Z",
          "updated_at": "2026-02-20T13:50:19.936Z",
          "id": 35,
          "createdAt": "2026-02-20T13:51:10.064Z",
          "updatedAt": "2026-02-20T13:51:10.064Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771595469936_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:50:29.936Z",
          "updated_at": "2026-02-20T13:50:29.936Z",
          "id": 36,
          "createdAt": "2026-02-20T13:51:10.169Z",
          "updatedAt": "2026-02-20T13:51:10.169Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771595469936_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:50:39.936Z",
          "updated_at": "2026-02-20T13:50:39.936Z",
          "id": 37,
          "createdAt": "2026-02-20T13:51:10.283Z",
          "updatedAt": "2026-02-20T13:51:10.283Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595567598_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T13:51:47.598Z",
          "updated_at": "2026-02-20T13:51:47.598Z",
          "id": 38,
          "createdAt": "2026-02-20T13:52:47.617Z",
          "updatedAt": "2026-02-20T13:52:47.617Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771595567598_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T13:51:57.598Z",
          "updated_at": "2026-02-20T13:51:57.598Z",
          "id": 39,
          "createdAt": "2026-02-20T13:52:47.679Z",
          "updatedAt": "2026-02-20T13:52:47.679Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771595567598_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T13:52:07.598Z",
          "updated_at": "2026-02-20T13:52:07.598Z",
          "id": 40,
          "createdAt": "2026-02-20T13:52:47.758Z",
          "updatedAt": "2026-02-20T13:52:47.758Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771595567598_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T13:52:17.598Z",
          "updated_at": "2026-02-20T13:52:17.598Z",
          "id": 41,
          "createdAt": "2026-02-20T13:52:47.846Z",
          "updatedAt": "2026-02-20T13:52:47.846Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771599043202_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T14:49:43.202Z",
          "updated_at": "2026-02-20T14:49:43.202Z",
          "id": 42,
          "createdAt": "2026-02-20T14:50:43.234Z",
          "updatedAt": "2026-02-20T14:50:43.234Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771599043202_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T14:49:53.202Z",
          "updated_at": "2026-02-20T14:49:53.202Z",
          "id": 43,
          "createdAt": "2026-02-20T14:50:43.320Z",
          "updatedAt": "2026-02-20T14:50:43.320Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771599043202_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T14:50:03.202Z",
          "updated_at": "2026-02-20T14:50:03.202Z",
          "id": 44,
          "createdAt": "2026-02-20T14:50:43.406Z",
          "updatedAt": "2026-02-20T14:50:43.406Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771599043202_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T14:50:13.202Z",
          "updated_at": "2026-02-20T14:50:13.202Z",
          "id": 45,
          "createdAt": "2026-02-20T14:50:43.494Z",
          "updatedAt": "2026-02-20T14:50:43.494Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771599831235_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget erfragen -> zu frueh im Call.",
          "reasoning_mode": "full_llm",
          "confidence": 0.65,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Preisfrage kam zu frueh.",
          "created_at": "2026-02-20T15:02:51.235Z",
          "updated_at": "2026-02-20T15:02:51.235Z",
          "id": 46,
          "createdAt": "2026-02-20T15:03:51.259Z",
          "updatedAt": "2026-02-20T15:03:51.259Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_price_harmful_1771599831235_2",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "price",
          "tip_text": "Budget klaeren -> Kunde blockt.",
          "reasoning_mode": "full_llm",
          "confidence": 0.66,
          "applied_by_rep": true,
          "outcome_label": "harmful",
          "outcome_note": "Kunde ist ausgestiegen.",
          "created_at": "2026-02-20T15:03:01.235Z",
          "updated_at": "2026-02-20T15:03:01.235Z",
          "id": 47,
          "createdAt": "2026-02-20T15:03:51.324Z",
          "updatedAt": "2026-02-20T15:03:51.324Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_timing_helpful_1771599831235_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "timing",
          "tip_text": "Termin fixieren -> naechster Schritt verbindlich.",
          "reasoning_mode": "full_llm",
          "confidence": 0.72,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Termin direkt vereinbart.",
          "created_at": "2026-02-20T15:03:11.235Z",
          "updated_at": "2026-02-20T15:03:11.235Z",
          "id": 48,
          "createdAt": "2026-02-20T15:03:51.383Z",
          "updatedAt": "2026-02-20T15:03:51.383Z"
        },
        "pairedItem": {
          "item": 0
        }
      },
      {
        "json": {
          "tip_id": "tip_sim_decision_helpful_1771599831235_1",
          "session_id": "call-1770112476",
          "lead_id": "lead_4ElyBEwAUnbK9ESo3eZHEgSUQL3SL0R6RY8Bg557JHN",
          "tip_type": "decision",
          "tip_text": "Entscheidung einfordern -> Klarheit geschaffen.",
          "reasoning_mode": "full_llm",
          "confidence": 0.74,
          "applied_by_rep": true,
          "outcome_label": "helpful",
          "outcome_note": "Naechster Schritt klar definiert.",
          "created_at": "2026-02-20T15:03:21.235Z",
          "updated_at": "2026-02-20T15:03:21.235Z",
          "id": 49,
          "createdAt": "2026-02-20T15:03:51.442Z",
          "updatedAt": "2026-02-20T15:03:51.442Z"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Webhook Tip Feedback": [
      {
        "json": {
          "headers": {
            "host": "viralhouse.app.n8n.cloud",
            "user-agent": "curl/8.7.1",
            "content-length": "129",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2003:e3:df35:db00:2010:4353:4a04:6990",
            "cf-ew-via": "15",
            "cf-ipcountry": "DE",
            "cf-ray": "9d0da95fa5b666db-AMS",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json",
            "x-forwarded-for": "2003:e3:df35:db00:2010:4353:4a04:6990, 172.71.99.177",
            "x-forwarded-host": "viralhouse.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-84-57fcbd49bc-mxt98",
            "x-is-trusted": "yes",
            "x-real-ip": "2003:e3:df35:db00:2010:4353:4a04:6990"
          },
          "params": {},
          "query": {},
          "body": {
            "tip_id": "tip_c7m6kr",
            "outcome_label": "helpful",
            "outcome_note": "Hat zu klarem naechsten Schritt gefuehrt",
            "applied_by_rep": true
          },
          "webhookUrl": "https://viralhouse.app.n8n.cloud/webhook-test/tip-outcome",
          "executionMode": "test"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Webhook GET Endpoint für Overlay": {
      "main": [
        [
          {
            "node": "Normalize Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert row": {
      "main": [
        [
          {
            "node": "Upsert row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Transcripts": {
      "main": [
        [
          {
            "node": "Conversation Memory Builder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Context Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Respond to Webhook new Session ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KI-Bremse": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Session Facts v1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cache Return Node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Delete Trash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Store in Cache",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook after AI-Break",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Trash": {
      "main": [
        [
          {
            "node": "Insert row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "lead_data_search",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "lead_data_search": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Parse Tip JSON (AI path)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Context Builder": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory Builder": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Context Packager": {
      "main": [
        [
          {
            "node": "KI-Bremse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Context Packager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in Cache": {
      "main": [
        [
          {
            "node": "Prepare Tip Feedback Row",
            "type": "main",
            "index": 0
          },
          {
            "node": "Respond to Webhook after AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Return Node": {
      "main": [
        [
          {
            "node": "Respond to Webhook after AI-Break",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Query": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Get Transcripts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Referenzanalyst",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Referenzanalyst",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Referenzen": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Referenzanalyst",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI3": {
      "ai_embedding": [
        [
          {
            "node": "Referenzen",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent Referenzanalyst",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "AI Agent Referenzanalyst",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Session Facts v1": {
      "main": [
        [
          {
            "node": "Upsert Session Facts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Rule Fastlane v1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Session Facts": {
      "main": [
        [
          {
            "node": "Load Session Facts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Session Facts": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Ensure Session Facts v1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "AI Agent Referenzanalyst": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rule Fastlane v1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Apply Fastlane Tip",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Apply Fastlane Tip": {
      "main": [
        [
          {
            "node": "Parse Tip JSON Fastlane",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tip JSON Fastlane": {
      "main": [
        [
          {
            "node": "Store in Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure Session Facts v1": {
      "main": [
        [
          {
            "node": "Load Lead Profile",
            "type": "main",
            "index": 0
          },
          {
            "node": "Load Tip Feedback",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Respond to Webhook after AI-Break": {
      "main": [
        []
      ]
    },
    "Prepare Tip Feedback Row": {
      "main": [
        [
          {
            "node": "Generate Feedback Test Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Tip Feedback": {
      "main": [
        []
      ]
    },
    "Load Tip Feedback": {
      "main": [
        [
          {
            "node": "Format Tip Feedback Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Tip Feedback Context": {
      "main": [
        [
          {
            "node": "Build Feedback Guidance v1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tip JSON (AI path)": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Outcome Payload": {
      "main": [
        [
          {
            "node": "Get Tip Feedback Row",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Payload + Row",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Update Tip Feedback": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tip Feedback Row": {
      "main": [
        [
          {
            "node": "Select Canonical Tip Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Payload + Row": {
      "main": [
        [
          {
            "node": "Guard Existing Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard Existing Row": {
      "main": [
        [
          {
            "node": "Update Tip Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Canonical Tip Row": {
      "main": [
        [
          {
            "node": "Merge Payload + Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Feedback Guidance v1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Feedback Test Rows": {
      "main": [
        [
          {
            "node": "Upsert Tip Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Lead Profile": {
      "main": [
        [
          {
            "node": "Extract Lead Profile from Pinecone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Lead Profile from Pinecone": {
      "main": [
        [
          {
            "node": "Parse Tip JSON (AI path)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Tip Feedback": {
      "main": [
        [
          {
            "node": "Validate Outcome Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "31e84ef1-7358-4fbe-8cf0-d294ac2a0fcd",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "72e3780aad95c596e53d0b6767e46271fd9d794792e1cc29bdf955a6c7308cc6"
  },
  "id": "JMHSa01VkTbbPgWg",
  "tags": []
}